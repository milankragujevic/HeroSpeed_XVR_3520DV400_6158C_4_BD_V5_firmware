function worker_func(){self.addEventListener("message",function(c){var b=c.data;switch(b.cmd){case"start":break;case"stop":this.postMessage({cmd:"stopped"});self.close();break;case"convert":var f=b.data;var a=_do_convert_yuv2rgb(f.chroma,f.y,f.u,f.v,f.w,f.h,f.stridey,f.strideu,f.stridev,f.bppy,f.bppu,f.bppv);this.postMessage({cmd:"converted",data:{image:a}},[a.buffer]);break;default:break}},0)}function _do_convert_yuv420(j,r,p,o,B,C,E,D,b,f,d,m){var a;var k;var s;var e=0;var g=0;var l=o>>1;var q=l*B;var n=0;var x=0;var c=0;var A;var t;for(var z=0;z<q;z++){t=z<<1;A=(e<<1);a=1.164*(j[n+A]-16);k=r[x+e]-128;s=p[c+e]-128;m[(t<<2)+0]=a+1.596*s;m[(t<<2)+1]=a-0.813*s-0.391*k;m[(t<<2)+2]=a+2.018*k;m[(t<<2)+3]=255;a=1.164*(j[n+A+1]-16);m[((t+1)<<2)+0]=a+1.596*s;m[((t+1)<<2)+1]=a-0.813*s-0.391*k;m[((t+1)<<2)+2]=a+2.018*k;m[((t+1)<<2)+3]=255;e++;if(e===l){e=0;g++;n+=C;x=((g>>1)*E);c=((g>>1)*D)}}}function _do_convert_yuv2rgb(f,j,n,m,l,d,a,c,b,e,i,g,k){if(!k){k=new Uint8ClampedArray(l*d*4)}switch(f){case 0:console.log("Chroma format not implemented yet",f,e,i,g);break;case 1:if(e!==8||i!==8||g!==8){console.log("Chroma format not implemented yet",f,e,i,g)}else{_do_convert_yuv420(j,n,m,l,d,a,c,b,e,i,g,k)}break;case 2:console.log("Chroma format not implemented yet",f,e,i,g);break;case 3:console.log("Chroma format not implemented yet",f,e,i,g);break;default:console.log("Unsupported chroma format",f,e,i,g);break}return k}var worker_blob_url=null;var WorkerConverter=function(){this.player=new RawPlayer(deviceSdk.video265);this.callbacks=[];if(worker_blob_url===null){var b=worker_func.toString();var d=worker_func.name;if(!d){d=/^function\s+([\w\$]+)\s*\(/.exec(b)[1]}var a=new Blob(["(function() {\n",_do_convert_yuv420.toString()+";\n",_do_convert_yuv2rgb.toString()+";\n",b+";\n",d+"();\n","}).call(this);"],{type:"text/javascript"});worker_blob_url=window.URL.createObjectURL(a)}var c=this;this.worker=new Worker(worker_blob_url);this.worker.addEventListener("message",function(h){switch(h.data.cmd){case"converted":if(c.callbacks.length>10){console.log("callbacks ",c.callbacks.length);c.callbacks=c.callbacks.slice(c.callbacks.length-5)}if(c.callbacks.length==0){break}for(var g=0;g<c.callbacks.length-1;g++){var f=c.callbacks[0];c.callbacks=c.callbacks.splice(1);f(h.data.data["image"])}break;case"stopped":c.callbacks=null;c=null;break;default:break}},false);this.worker.postMessage({cmd:"start"})};WorkerConverter.prototype.destroy=function(){if(this.worker){this.worker.postMessage({cmd:"stop"});this.worker=null}};WorkerConverter.prototype.convert=function(i,l,o,n,m,e,a,d,c,g,k,j){var b={cmd:"convert",data:{chroma:i,y:l,u:o,v:n,w:m,h:e,stridey:a,strideu:d,stridev:c,bppy:g,bppu:k,bppv:j}};var p=this.player._get_img_data(m,e);var f=this;this.callbacks.push(function(s){if(p.data.set){p.data.set(s)}else{var h=p.data;var r=h.length;for(var q=0;q<r;q++){h[q]=s[q]}}f.player._display_image(p)});this.worker.postMessage(b,[l.buffer,o.buffer,n.buffer])};var RawPlayer=function(a){this.canvas=a;this.ctx=a.getContext("2d");this.ratio=null;this.filters=false;this._reset()};RawPlayer.prototype._reset=function(){this.start=null;this.frames=0;this.image_data=null;this.running=false;this.queue=null;this.pending_image_data=null;this.queue=[]};RawPlayer.prototype._get_img_data=function(a,c){if(a!=this.canvas.width||c!=this.canvas.height||!this.image_data){this.canvas.width=a;this.canvas.height=c;this.image_data=this.ctx.createImageData(a,c);var d=this.image_data.data;for(var b=0;b<a*c;b++){d[b*4+3]=255}}return this.image_data};RawPlayer.prototype._display_image=function(b){if(window.requestAnimationFrame){this.pending_image_data=b;var a=this;window.requestAnimationFrame(function(){if(a.pending_image_data){a.ctx.putImageData(a.pending_image_data,0,0);a.pending_image_data=null}})}else{this.ctx.putImageData(b,0,0)}return b};RawPlayer.prototype.stop=function(){this._reset()};RawPlayer.prototype.set_framerate_ratio=function(a){this.ratio=a};RawPlayer.prototype.disable_filters=function(a){this.filters=a};