var smartEventsVariables={wsId:0};var videoWidth;var videoHeight;var drawType=0;var countNum=0;function onLoad(){initDot();setTitle(lang.smartyDetect);bindTagHead();$("#videoBlock").isPlayer({isConfigVideo:true});videoWidth=$("#videoBlock").width();videoHeight=$("#videoBlock").height();if(checkPluginInstall()){var a=$("#videoBlock");a.isPlayer("initVideoWindow",getDeviceValue()).isPlayer("stopAllVideo");a.isPlayer("setPlayWindowNum",2);a.isPlayer("setWindowType",10);a.isPlayer("setSmartyCrossEn",false);a.isPlayer("setSmartyBlockEn",false)}smartDetectInit()}function onUnload(){var a=$("#selSmtDetect").data("last-ch");a!==undefined&&$("#videoBlock").isPlayer("stopPreview",a);$("#videoBlock").isPlayer("destroy")}var smartDetectVariables={};var plugin=window.top.plugin;var staText="";var ruleValue=new Array();var loginpsw=window.top.loginpsw;function smartDetectInit(){initSmartDetectChannel();initEditNumberStyle();initLsSlide();if(getConf("isNvrAlarmOutEn")){$(".alarmout").show()}initSmtCheckbox($("#divHumanAccord .alarmout"),getConf("isNvrAlarmOutEn"),"humanDetAlarmOut");initSmtCheckbox($("#divFaceAccord .alarmout"),getConf("isNvrAlarmOutEn"),"peopleFaceDetectAlarmOut");initSmtCheckbox($("#divCrossAccord .alarmout"),getConf("isNvrAlarmOutEn"),"peopleCrossAlarmOut");initSmtCheckbox($("#divBlockAccord .alarmout"),getConf("isNvrAlarmOutEn"),"peopleIntrusionAlarmOut");initSmtCheckbox($("#divHoverAccord .alarmout"),getConf("isNvrAlarmOutEn"),"peopleLoiteringAlarmOut");initSmtCheckbox($("#divGatherAccord .alarmout"),getConf("isNvrAlarmOutEn"),"peopleGatherAlarmOut");if(isXVR()){$(".xvrHuman").removeClass("hide");$("#divHuman").removeClass("hide");$(".xvrSmtEnable").removeClass("hide");$(".xvrSensitivity").removeClass("hide");$("#divFaceAccord h3").eq(1).remove();$("#divFaceAccord .group").eq(1).remove();$(".fullScreenMonitoring").addClass("hide")}if(getConf("removeBuzzer")){$("#getfacedetbeepen").attr("disabled",true);$("#gethumandetbeepen").attr("disabled",true)}$(".J-rule-type").change(onCrossRuleChg);$(".J-rule-direction").change(onCrossDirectChg);$("#selBlkRule").change(onBlockRuleChg);$("#selHoverRule").change(onHoverRuleChg);$("#selGatherRule").change(onGatherRuleChg);$(".J-rule-time").change(function(){$(this).prop("id")=="selBlockTime"?upRuleChange($("#selBlkRule"),"blk-data",$(this)):upRuleChange($("#selHoverRule"),"hover-data",$(this))})}function initSmartDetectChannel(){getSmtChBits(function(d,b){if(d!=HTTP_OK||b.length===0){rightPopup(lang.optionexception);return}window.arrChFunc=b;var a=[];for(var c=0;c<getTotalChannelNum();c++){a.push(window.top.nSynConfigDatabit[0])}initChannelSelect($("#selSmtDetect"),getTotalChannelNum(),function(e){return(isFaceEn(window.arrChFunc[e])||isCrossEn(window.arrChFunc[e])||isBlockEn(window.arrChFunc[e])||isHoverEn(window.arrChFunc[e])||isGatherEn(window.arrChFunc[e]))});if(isXVR()){initChannelSelect($("#selSmtDetect"),getTotalChannelNum(),function(e){return(isHumanEn(window.arrChFunc[e])||isFaceEn(window.arrChFunc[e])||isCrossEn(window.arrChFunc[e])||isBlockEn(window.arrChFunc[e])||isHoverEn(window.arrChFunc[e])||isGatherEn(window.arrChFunc[e]))})}eventresize();$("#selSmtDetect").change(function(){var e=$(this).val();getSmtChannelEnable(Number(e))}).change()})}function getSmtChannelEnable(a,b){initTabs();loading(true);countNum=0;api.channelCapability(REQUEST_GET,{channel:a},function(f,g){if(f!=CODE_SUCCESS){for(var e=0;e<5;++e){$("#divTabs").tabs("disable",e)}return}var d=["supportFace","supportCrossBorderDetection","supportRegionalIntrusionDetection","supportPeopleStayDetection","supportPeopleGatheringDetection"];for(var e=0;e<d.length;e++){if(g[d[e]]==0){$("#divTabs").tabs("disable",e+1)}else{$("#divTabs").tabs("enable",e+1);countNum++}}if(g.supportFace!=4){$(".J-face-mode>option").eq(2).remove();$(".J-is-humandet").show()}else{$(".J-is-humandet").hide();$(".J-face-mode").append("<option value='2'>"+lang.smtHumDet+"</option>")}var c=function(j){for(var h=0;h<d.length;h++){if(j[d[h]]!=0){setTimeout(function(){$("#divTabs").tabs({selected:h+1});drawType=h},500);break}}};loading(true);loadSmartDetectData(g);loadLineCrossingData(g,c);loadRegionalIntrusionData(g,c);loadLoiteringData(g,c);loadGatherData(g,c);startSmVideo(a)})}function startSmVideo(c){var b=$("#selSmtDetect").data("last-ch");var a=$("#videoBlock");b!==undefined&&a.isPlayer("stopPreview",b);$("#selSmtDetect").data("last-ch",c);if(checkPluginInstall()){a.isPlayer("setHttpPort").isPlayer("startPreview",1,c)}else{$("#videoBlock>.J-plugin-block").html("");var d=function(){configPurePlay(c,null,null,smartEventsVariables.wsId);smartEventsVariables.wsId++};getPlayEncodeInfo(c,d,true)}}function initTabs(){$("#divTabs").removeClass("hide").tabs({activate:onTabChg}).position({of:$("#videoBlock"),at:"right top",my:"left top"});$("#divHumanAccord").accordion({collapsible:true,heightStyle:"content"});$("#divFaceAccord").accordion({collapsible:true,heightStyle:"content"});$("#divCrossAccord").accordion({collapsible:true,heightStyle:"content"});$("#divBlockAccord").accordion({collapsible:true,heightStyle:"content"});$("#divHoverAccord").accordion({collapsible:true,heightStyle:"content"});$("#divGatherAccord").accordion({collapsible:true,heightStyle:"content"})}function initEditNumberStyle(){setEditNumberStyle($("#iptCrossSens"),false,function(d,f,b){var e=$("#selCrsRule");var c=e.data("crs-data");var a=ParseInt(e.val());c[a].sensitivity=parseInt(b);e.data("crs-data",c)});setEditNumberStyle($("#iptBlockSens"),false,function(d,f,b){var e=$("#selBlkRule");var c=e.data("blk-data");var a=ParseInt(e.val());c[a].sensitivity=parseInt(b);e.data("blk-data",c)});setEditNumberStyle($("#iptHoverSens"),false,function(d,f,b){var e=$("#selHoverRule");var c=e.data("hover-data");var a=ParseInt(e.val());c[a].sensitivity=parseInt(b);e.data("hover-data",c)})}function loadSmartDetectData(b){if(b.supportFace==0){return}var a=$("#selSmtDetect").val();api.faceDetect(REQUEST_GET,{channel:parseInt(a)},function(c,d){if(c!=CODE_SUCCESS){return}autoFillValue("faceDetect",d);getVal2Bit("peopleFaceDetectAlarmOut",d.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"))})}function saveSmartDetectData(b){var a=getMatchValue("faceDetect");a.trigger.alarmOutChannelMask=setBit2Val("peopleFaceDetectAlarmOut",getConf("isNvrAlarmOutEn"))+"";if(a.channel=="undefined"){return}api.faceDetect(REQUEST_SET,a,function(c,d){if(c!=CODE_SUCCESS){return}rightPopup(lang.saved);b&&b()})}function loadLineCrossingData(a,c){if(a.supportCrossBorderDetection==0){return}var b=$("#selSmtDetect").val();api.lineCrossing(REQUEST_GET,{channel:parseInt(b)},function(e,f){if(e!=CODE_SUCCESS){return}autoFillValue("lineCrossing",f);getVal2Bit("peopleCrossAlarmOut",f.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"));for(var d=0;d<f.ruleList.length;d++){f.ruleList[d].x1=ParseInt(f.ruleList[d].x1*videoWidth/10000);f.ruleList[d].y1=ParseInt(f.ruleList[d].y1*videoHeight/10000);f.ruleList[d].x2=ParseInt(f.ruleList[d].x2*videoWidth/10000);f.ruleList[d].y2=ParseInt(f.ruleList[d].y2*videoHeight/10000)}$("#selCrsRule").data("crs-data",f.ruleList);$("#iptCrossSens").val(f.ruleList[0].sensitivity);c&&c(a)})}function saveLineCrossingData(d){var a=$("#selCrsRule").data("crs-data");if(!a){return}for(var b=0;b<a.length;b++){delete a[b].sensitiveMin;delete a[b].sensitiveMax;delete a[b].directionMin;delete a[b].directionMax;a[b].x1=ParseInt(a[b].x1/videoWidth*10000);a[b].y1=ParseInt(a[b].y1/videoHeight*10000);a[b].x2=ParseInt(a[b].x2/videoWidth*10000);a[b].y2=ParseInt(a[b].y2/videoHeight*10000)}var c=getMatchValue("lineCrossing");c.trigger.alarmOutChannelMask=setBit2Val("peopleCrossAlarmOut",getConf("isNvrAlarmOutEn"))+"";c.ruleList=a;api.lineCrossing(REQUEST_SET,c,function(f,g){if(f!=CODE_SUCCESS){return}rightPopup(lang.saved);for(var e=0;e<a.length;e++){a[e].x1=ParseInt(a[e].x1*videoWidth/10000);a[e].y1=ParseInt(a[e].y1*videoHeight/10000);a[e].x2=ParseInt(a[e].x2*videoWidth/10000);a[e].y2=ParseInt(a[e].y2*videoHeight/10000)}d&&d()})}function loadRegionalIntrusionData(a,c){if(a.supportRegionalIntrusionDetection==0){return}var b=$("#selSmtDetect").val();api.regionalIntrusion(REQUEST_GET,{channel:parseInt(b)},function(d,e){if(d!=CODE_SUCCESS){return}autoFillValue("regionalIntrusion",e);getVal2Bit("peopleIntrusionAlarmOut",e.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"));e.ruleList=extremelyDataToCoords(e.ruleList);$("#selBlkRule").data("blk-data",e.ruleList);$("#iptBlockSens").val(e.ruleList[0].sensitivity);$("#selBlockTime").val(e.ruleList[0].time);c&&c(a)})}function saveRegionalIntrusionData(c){var a=getExtremelyData($("#selBlkRule").data("blk-data"));var b=getMatchValue("regionalIntrusion");if(!a){return}b.trigger.alarmOutChannelMask=setBit2Val("peopleIntrusionAlarmOut",getConf("isNvrAlarmOutEn"))+"";b.ruleList=a;api.regionalIntrusion(REQUEST_SET,b,function(d,e){if(d!=CODE_SUCCESS){return}rightPopup(lang.saved);extremelyDataToCoords(a);c&&c()})}function loadLoiteringData(a,c){if(a.supportPeopleStayDetection==0){return}var b=$("#selSmtDetect").val();api.loitering(REQUEST_GET,{channel:parseInt(b)},function(d,e){if(d!=CODE_SUCCESS){return}autoFillValue("loitering",e);getVal2Bit("peopleLoiteringAlarmOut",e.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"));e.ruleList=extremelyDataToCoords(e.ruleList);$("#selHoverRule").data("hover-data",e.ruleList);$("#iptHoverSens").val(e.ruleList[0].sensitivity);$("#selHoverTime").val(e.ruleList[0].time);c&&c(a)})}function saveLoiteringData(c){var a=getExtremelyData($("#selHoverRule").data("hover-data"));var b=getMatchValue("loitering");if(!a){return}b.trigger.alarmOutChannelMask=setBit2Val("peopleLoiteringAlarmOut",getConf("isNvrAlarmOutEn"))+"";b.ruleList=a;api.loitering(REQUEST_SET,b,function(d,e){if(d!=CODE_SUCCESS){return}rightPopup(lang.saved);extremelyDataToCoords(a);c&&c()})}function loadGatherData(a,c){if(a.supportPeopleGatheringDetection==0){return}var b=$("#selSmtDetect").val();api.peopleGathering(REQUEST_GET,{channel:parseInt(b)},function(d,e){if(d!=CODE_SUCCESS){return}autoFillValue("peopleGather",e);getVal2Bit("peopleGatherAlarmOut",e.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"));e.ruleList=extremelyDataToCoords(e.ruleList);$("#selGatherRule").data("gather-data",e.ruleList);$("#iptGahterRadio").val(e.ruleList[0].persionNum);$(".ls-slide").slider({min:e.ruleList[0].persionNumMin,max:e.ruleList[0].persionNumMax,value:e.ruleList[0].persionNum,slide:function(f,g){$("#iptGahterRadio").val(g.value);upRuleChange($("#selGatherRule"),"gather-data",$("#iptGahterRadio"))}});c&&c(a)})}function saveGatherData(c){var a=getExtremelyData($("#selGatherRule").data("gather-data"));var b=getMatchValue("peopleGather");if(!a){return}b.trigger.alarmOutChannelMask=setBit2Val("peopleGatherAlarmOut",getConf("isNvrAlarmOutEn"))+"";b.ruleList=a;api.peopleGathering(REQUEST_SET,b,function(d,e){if(d!=CODE_SUCCESS){return}rightPopup(lang.saved);extremelyDataToCoords(a);c&&c()})}function getExtremelyData(a){if(!a){return false}for(var b=0;b<a.length;b++){delete a[b].persionNumMin;delete a[b].persionNumMax;delete a[b].sensitiveMin;delete a[b].sensitiveMax;delete a[b].timeMin;delete a[b].timeMax;a[b].x1=parseInt((a[b].x1/videoWidth*10000).toFixed(0));a[b].y1=parseInt((a[b].y1/videoHeight*10000).toFixed(0));a[b].x2=parseInt((a[b].x2/videoWidth*10000).toFixed(0));a[b].y2=parseInt((a[b].y2/videoHeight*10000).toFixed(0));a[b].x3=parseInt((a[b].x3/videoWidth*10000).toFixed(0));a[b].y3=parseInt((a[b].y3/videoHeight*10000).toFixed(0));a[b].x4=parseInt((a[b].x4/videoWidth*10000).toFixed(0));a[b].y4=parseInt((a[b].y4/videoHeight*10000).toFixed(0))}return a}function extremelyDataToCoords(a){if(!a){return false}for(var b=0;b<a.length;b++){a[b].x1=parseInt((a[b].x1*videoWidth/10000).toFixed(0));a[b].y1=parseInt((a[b].y1*videoHeight/10000).toFixed(0));a[b].x2=parseInt((a[b].x2*videoWidth/10000).toFixed(0));a[b].y2=parseInt((a[b].y2*videoHeight/10000).toFixed(0));a[b].x3=parseInt((a[b].x3*videoWidth/10000).toFixed(0));a[b].y3=parseInt((a[b].y3*videoHeight/10000).toFixed(0));a[b].x4=parseInt((a[b].x4*videoWidth/10000).toFixed(0));a[b].y4=parseInt((a[b].y4*videoHeight/10000).toFixed(0))}return a}function closeDraw(){var a=$("#btnDrawLine");if(a.hasClass("ui-state-error-text")){a.click()}a=$(".btnDrawRect");a.each(function(){$(this).hasClass("ui-state-error-text")&&$(this).click()})}function onSaveClk(){var a=ParseInt($("#selSmtDetect").val());upFirstData();if(!a&&a!=0){rightPopup(lang.nolimit);return}closeDraw();loading(true);saveSmartDetectData();saveLineCrossingData();saveRegionalIntrusionData();saveLoiteringData();saveGatherData()}function upFirstData(){var a="",d="";if(drawType==1){a="crs-data";d="#selCrsRule"}if(drawType==2){a="blk-data";d="#selBlkRule"}if(drawType==3){a="hover-data";d="#selHoverRule"}if(drawType==4){a="gather-data";d="#selGatherRule"}var b=$(d).val();var c=$(d).data(a);if(a==""){return}drawType==1?updateBlkRegionData(c[b],true,false):updateBlkRegionData(c[b],false,false)}function onTabChg(h,e){var c=e.oldPanel.attr("id");var b={divBlock:"blk",divHover:"hover",divGather:"gather",divCross:"crs"};switch(e.newPanel.attr("id")){case"divBlock":drawType=2;break;case"divHover":drawType=3;break;case"divGather":drawType=4;break;default:drawType=1;break}closeDraw();if(b[c]){var f=$("#sel"+firstUppercase(b[c])+"Rule");var a=f.data(b[c]+"-data");var d=parseInt(f.val());setClearAllBtn("#videoBlock",null,"line-cross-position",true);b[c]!="crs"?updateBlkRegionData(a[d]):updateBlkRegionData(a[d],true)}c=e.newPanel.attr("id");if(b[c]){var f=$(e.newPanel).find(".selRule");f.data("pre-rule",null);f.data(b[c]+"-data")&&b[c]!="crs"&&f.val(f.find("option").eq(0).val()).change();b[c]=="crs"&&$("#selCrsRule").val(0).change()}var g=$("#videoBlock");var i=$(e.newTab).find("[live-type]").attr("live-type");isIE()&&g.isPlayer("setWindowType",i);!b[c]&&$("#videoBlock").isPlayer("clearDrawBtn")}function updateBlkRegionData(b,d,a){if(checkPluginInstall()){if(d){var c=$("#videoBlock").isPlayer("getSmartyCrossLine",",").split(",");if(a){c=[0,0,0,0]}b.x1=ParseInt(c[0]);b.y1=ParseInt(c[1]);b.x2=ParseInt(c[2]);b.y2=ParseInt(c[3])}else{var c=$("#videoBlock").isPlayer("getSmartyBlockPt",",").split(",");if(a){c=[0,0,0,0,0,0,0,0]}b.x1=ParseInt(c[0]);b.y1=ParseInt(c[1]);b.x2=ParseInt(c[2]);b.y2=ParseInt(c[3]);b.x3=ParseInt(c[4]);b.y3=ParseInt(c[5]);b.x4=ParseInt(c[6]);b.y4=ParseInt(c[7])}}}function onDrawLineClk(){var b=$("#videoBlock");var c=$(this);var a=!c.hasClass("ui-state-error-text");drawType=1;if(isIE()){b.isPlayer("setSmartyCrossEn",a)}else{onBtnLDToggleDraw(a)}c.toggleClass("ui-state-error-text")}function onBtnLDToggleDraw(a){var c=parseInt($(".J-guard-area1").val()),b=$("#videoBlock"),d=$(".J-rule-direction").val();if(a){b.isPlayer("setDrawBtn",c,null,true,changeCrossRule,d)}else{$(".draw-box").off("mousemove").off("mousedown").off("mouseup").off("mouseout")}}function changeCrossRule(a){var b=$("#selCrsRule").data("crs-data"),c=$("#selCrsRule").val();b[c].x1=Number(a[0].x);b[c].y1=Number(a[0].y);b[c].x2=Number(a[1].x);b[c].y2=Number(a[1].y);$("#selCrsRule").data("crs-data",b)}function onBtnLDClrAllClk(){setClearAllBtn("#videoBlock",null,"line-cross-position",true)}function setAreaData(a,b,d,c){setTimeout(function(){b=isIE()?b:b[ZERO];$(a).lsplayer("setDrawArea",b,d,c)},500)}function onClearLineClk(){checkPluginInstall()?$("#videoBlock").isPlayer("setSmartyCrossLine",0,0,0,0):onBtnLDClrAllClk();var b=$("#selCrsRule").data("crs-data");var a=b[$("#selCrsRule").val()];a.x1=0;a.y1=0;a.x2=0;a.y2=0}function isEmptyPosition(b){var c=[];for(var a in b){b[a].x==0&&c.push(b[a].x);b[a].y==0&&c.push(b[a].y)}return c}function getCoord(e,b){var a=[];var d=0;for(var c in e){d++;if(d<b+1){continue}if(Object.hasOwnProperty.call(e,c)){a.push(parseInt(e[c]))}}return a}function onDrawRectClk(){var d=$(this);var b=!d.hasClass("ui-state-error-text");var a,c;drawType=d.attr("data-type");if(checkPluginInstall()){$("#videoBlock").isPlayer("setSmartyBlockEn",b)}else{if(drawType==2){a="blk-data";c="#selBlkRule"}if(drawType==3){a="hover-data";c="#selHoverRule"}if(drawType==4){a="gather-data";c="#selGatherRule"}setDrawAreaBtn(c,"#videoBlock",a,b)}d.toggleClass("ui-state-error-text")}function onClearRectClk(){var a=$(this).parents("div").eq(0).attr("id");var b={divBlock:"blk",divHover:"hover",divGather:"gather",divCross:"crs"};if(b[a]){var e=$("#sel"+firstUppercase(b[a])+"Rule");var c=e.data(b[a]+"-data");var d=parseInt(e.val());c[d].x1=0;c[d].y1=0;c[d].x2=0;c[d].y2=0;c[d].x3=0;c[d].y3=0;c[d].x4=0;c[d].y4=0;e.data(b[a]+"-data",c)}if(checkPluginInstall()){$("#videoBlock").isPlayer("setSmartyBlockPt",[0,0,0,0,0,0,0,0])}else{setClearAllBtn("#videoBlock",".J-guard-area","intrusion-position");$(".draw-box").off("mousedown")}}function setDrawAreaBtn(d,c,b,a){a?drawable($(c),$(d),b,a):$(".draw-box").off("mousedown")}function drawable(d,c,b,a){d.isPlayer("setDrawBtn",1,a,false,function(e){var f=c.data(b);f[c.val()].x1=Number(e[0].x);f[c.val()].y1=Number(e[0].y);f[c.val()].x2=Number(e[1].x);f[c.val()].y2=Number(e[1].y);f[c.val()].x3=Number(e[2].x);f[c.val()].y3=Number(e[2].y);f[c.val()].x4=Number(e[3].x);f[c.val()].y4=Number(e[3].y);c.data(b,f);$(".draw-box").off("mousedown");$(".J-draw-click").toggleClass("ui-state-error-text")})}function setClearAllBtn(c,h,b,g){var d=$(c),a=parseInt($(h).val()),f=d.data(b);var e=$(".J-draw-click").hasClass("ui-state-error-text");d.data(b,f).isPlayer("clearDrawBtn",a,g);if(e&&!isIE()&&!g){drawAgain(d,a,b)}}function drawAgain(d,b,a){var c=$(".J-draw-click").hasClass("ui-state-error-text");d.isPlayer("setQuadrilateralDraw",function(e){},"",c)}function clearPosition(d){var c=[],a=d?BORDER_POINT_LIMIT:QUADRILATERAL_POINT_LIMIT;for(var b=0;b<a;b++){c[b]={};c[b].x=String(ZERO);c[b].y=String(ZERO)}return c}function checkCrossLine(f){var c=0,h=0,e=0;c=(f[0].y-f[1].y)/(f[0].x-f[1].x);for(e=2;e<4;e++){h=(f[0].y-f[e].y)/(f[0].x-f[e].x);if(h!=c){break}}if(e>=4){return -2}var d,b,a,g;d=(f[2].x-f[0].x)*(f[1].y-f[0].y)-(f[1].x-f[0].x)*(f[2].y-f[0].y);b=(f[3].x-f[0].x)*(f[1].y-f[0].y)-(f[1].x-f[0].x)*(f[3].y-f[0].y);a=(f[0].x-f[2].x)*(f[3].y-f[2].y)-(f[3].x-f[2].x)*(f[0].y-f[2].y);g=(f[1].x-f[2].x)*(f[3].y-f[2].y)-(f[3].x-f[2].x)*(f[1].y-f[2].y);if(d*b<=1e-8&&a*g<=1e-8){return -2}d=(f[0].x-f[1].x)*(f[2].y-f[1].y)-(f[2].x-f[1].x)*(f[0].y-f[1].y);b=(f[3].x-f[1].x)*(f[2].y-f[1].y)-(f[2].x-f[1].x)*(f[3].y-f[1].y);a=(f[1].x-f[0].x)*(f[3].y-f[0].y)-(f[3].x-f[0].x)*(f[1].y-f[0].y);g=(f[2].x-f[0].x)*(f[3].y-f[0].y)-(f[3].x-f[0].x)*(f[2].y-f[0].y);if(d*b<=1e-8&&a*g<=1e-8){return -2}return f}function onCrossRuleChg(){var g=$(this);var c=$("#videoBlock");var d=g.data("crs-data");var a=ParseInt(g.val());var b=g.data("pre-rule");if($.isNumeric(b)&&checkPluginInstall()){var f=c.isPlayer("getSmartyCrossLine",",").split(",");b=ParseInt(b);d[b].sensitivity=Number($("#iptCrossSens").val());d[b].direction=Number($("#selCrossDirect").val());d[b].x1=ParseInt(f[0]);d[b].y1=ParseInt(f[1]);d[b].x2=ParseInt(f[2]);d[b].y2=ParseInt(f[3]);g.data("crs-data",d)}g.data("pre-rule",a);$("#iptCrossSens").val(d[a].sensitivity);$("#selCrossDirect").val(d[a].direction);if(checkPluginInstall()){c.isPlayer("setSmartyCrossRule",a);c.isPlayer("setSmartyCrossType",d[a].direction);c.isPlayer("setSmartyCrossLine",d[a].x1,d[a].y1,d[a].x2,d[a].y2)}else{var e=[{x:d[a].x1,y:d[a].y1},{x:d[a].x2,y:d[a].y2}];c.isPlayer("setDrawArea",e,true,$("#selCrossDirect").val());$(".draw-box").off("mousemove").off("mousedown").off("mouseup").off("mouseout");$("#btnDrawLine").removeClass("ui-state-error-text")}}function coordinateRate(b,c){var a={};a.x=b/10000*videoWidth;a.y=c/10000*videoHeight;return a}function onBlockRuleChg(){var g=$(this);var d=g.data("blk-data");var a=ParseInt(g.val());var b=g.data("pre-rule");var c=$("#videoBlock");if($.isNumeric(b)&&isIE()){b=ParseInt(b);d[b].sensitivity=parseInt($("#iptBlockSens").val());d[b].time=parseInt($("#selBlockTime").val());b=ParseInt(b);var f=c.isPlayer("getSmartyBlockPt",",").split(",");d[b].x1=ParseInt(f[0]);d[b].y1=ParseInt(f[1]);d[b].x2=ParseInt(f[2]);d[b].y2=ParseInt(f[3]);d[b].x3=ParseInt(f[4]);d[b].y3=ParseInt(f[5]);d[b].x4=ParseInt(f[6]);d[b].y4=ParseInt(f[7]);g.data("blk-data",d)}g.data("pre-rule",a);$("#iptBlockSens").val(d[a].sensitivity);$("#selBlockTime").val(d[a].time);if(checkPluginInstall()){c.isPlayer("setSmartyBlockRule",a);c.isPlayer("setSmartyBlockPt",[d[a].x1,d[a].y1,d[a].x2,d[a].y2,d[a].x3,d[a].y3,d[a].x4,d[a].y4])}else{var e=[{x:d[a].x1,y:d[a].y1},{x:d[a].x2,y:d[a].y2},{x:d[a].x3,y:d[a].y3},{x:d[a].x4,y:d[a].y4}];c.isPlayer("setDrawArea",e)}}function onHoverRuleChg(){var g=$(this);var d=g.data("hover-data");var a=ParseInt(g.val());var b=g.data("pre-rule");var c=$("#videoBlock");if($.isNumeric(b)&&checkPluginInstall()){d[b].sensitivity=parseInt($("#iptHoverSens").val());d[b].time=parseInt($("#selHoverTime").val());b=ParseInt(b);var f=c.isPlayer("getSmartyBlockPt",",").split(",");d[b].x1=ParseInt(f[0]);d[b].y1=ParseInt(f[1]);d[b].x2=ParseInt(f[2]);d[b].y2=ParseInt(f[3]);d[b].x3=ParseInt(f[4]);d[b].y3=ParseInt(f[5]);d[b].x4=ParseInt(f[6]);d[b].y4=ParseInt(f[7]);g.data("hover-data",d)}g.data("pre-rule",a);$("#iptHoverSens").val(d[a].sensitivity);$("#selHoverTime").val(d[a].time);if(checkPluginInstall()){c.isPlayer("setSmartyBlockRule",a);c.isPlayer("setSmartyBlockPt",[d[a].x1,d[a].y1,d[a].x2,d[a].y2,d[a].x3,d[a].y3,d[a].x4,d[a].y4])}else{var e=[{x:d[a].x1,y:d[a].y1},{x:d[a].x2,y:d[a].y2},{x:d[a].x3,y:d[a].y3},{x:d[a].x4,y:d[a].y4}];c.isPlayer("setDrawArea",e)}}function onGatherRuleChg(){var g=$(this);var d=g.data("gather-data");var a=ParseInt(g.val());var b=g.data("pre-rule");var c=$("#videoBlock");if($.isNumeric(b)&&checkPluginInstall()){d[b].persionNum=parseInt($("#iptGahterRadio").val());b=ParseInt(b);var f=c.isPlayer("getSmartyBlockPt",",").split(",");d[b].x1=ParseInt(f[0]);d[b].y1=ParseInt(f[1]);d[b].x2=ParseInt(f[2]);d[b].y2=ParseInt(f[3]);d[b].x3=ParseInt(f[4]);d[b].y3=ParseInt(f[5]);d[b].x4=ParseInt(f[6]);d[b].y4=ParseInt(f[7]);g.data("gather-data",d)}g.data("pre-rule",a);$("#iptGahterRadio").val(d[a].persionNum).change();if(checkPluginInstall()){c.isPlayer("setSmartyBlockRule",a);c.isPlayer("setSmartyBlockPt",[d[a].x1,d[a].y1,d[a].x2,d[a].y2,d[a].x3,d[a].y3,d[a].x4,d[a].y4])}else{var e=[{x:d[a].x1,y:d[a].y1},{x:d[a].x2,y:d[a].y2},{x:d[a].x3,y:d[a].y3},{x:d[a].x4,y:d[a].y4}];c.isPlayer("setDrawArea",e)}}function upRuleChange(c,b,e){var d=c.data(b);var a=ParseInt(c.val());if(b=="gather-data"){d[a].persionNum=parseInt(e.val())}else{d[a].time=parseInt(e.val())}c.data(b,d)}function onCrossDirectChg(){var c=$("#selCrsRule");var b=c.data("crs-data");var a=ParseInt(c.val());b[a].direction=parseInt($(this).val());c.data("crs-data",b);checkPluginInstall()&&plugin().setSmartyCrossType(b[a].direction)}function initSmtCheckbox(a,c,d){var b=limitRange((c/8).toFixed(1));switch(b){case 1:addInput(a,0,0,c,d);break;case 2:addInput(a,0,0,8,d);addInput(a,1,8,c,d);break;case 3:addInput(a,0,0,8,d);addInput(a,1,8,16,d);addInput(a,2,16,c,d);break;case 4:addInput(a,0,0,8,d);addInput(a,1,8,16,d);addInput(a,2,16,24,d);addInput(a,3,24,c,d);break;default:addInput(a,0,c,d);break}}function addInput(a,d,e,b,f){for(var c=e;c<b;c++){a.eq(d).find("td").eq(1).append('<label><input type="checkbox" matchval="'+f+c+'" id="'+f+c+'">'+(c+1)+"</label>")}}function limitRange(b){var c=b.split(".");var a=parseInt(c[0]);if(c[1]>0){a+=1}return a}function getNG(d){var b={};d=String(d);if(!d){return b}d=d.replace(/NG /mg,"\r\nNG ");d=d.replace(/OK /mg,"\r\nOK ");var c=new RegExp(/(OK (.+))|(NG (.+))$/mg);var a=null;while(a=c.exec(d)){if(a[2]){b[a[2]]=a[0].split(" "+a[2])[0]}else{b[a[4]]=a[0].split(" "+a[4])[0]}}return b}var faceComparisonVariables={};function onFaceComparisonLoad(){console.log("load")}function initSmtFaceCmp(){initTable();if(ParseInt(getDevConf("alarmOutNum"))>0){$(".blkAlarm").removeClass("hide");initCheckbox($(".blkAlarm"),getDevConf("alarmOutNum"),"getfacecomparealarmout");if(isNVR()){$("[matchval='getfacecomparerecorden']").parent().show();$("[matchval='getfacecomparefullscreenen']").parent().show()}}if(isXVR()){$("[matchval='getfacecomparerecorden']").parent().show()}if(getConf("removeBuzzer")){$("[matchval=getfacecomparebeepen]").attr("disabled",true)}$("#chkAll").change(function(){if($("#chkAll").prop("checked")){$("tbody input[type='checkbox']").prop("checked",true)}else{$("tbody input[type='checkbox']").prop("checked",false)}});getSmtChBits(function(d,c){var b=getTotalChannelNum();var e=window.top.faceGetOsdChannal;if(d!=HTTP_OK||c.length!==b){rightPopup(lang.optionexception);return}if(getConf("isSmtCmpCh")){faceGetFaceCmpchannal($("#selFaceCh"))}else{initChannelSelect($("#selFaceCh"),b,function(f){return isFaceCmpEn(c[f])},0)}});var a=$("#dlgHandle").removeClass("hide").attr("title",lang.handleMode).dialog({modal:true,autoOpen:false,width:"auto",buttons:[{text:lang.confirm,"class":"web-btn",click:function(){a.dialog("close")}},{text:lang.cancel,"class":"dis",click:function(){a.dialog("close")}}],position:{of:$(".J-face-com-table"),at:"center top",my:"center top"},draggable:false});$("#btnHandle").click(function(){a.dialog("open")})}function initTable(){initSimpleTable($(".J-face-com-table"),{ordering:true,columnDefs:[{targets:0,orderData:[0,1],orderable:false,render:function(c,b,a,d){return c=="1"?'<input type="checkbox" checked="checked"/>':'<input type="checkbox"/>'},minWidth:100},{targets:1,data:"name",render:function(c,b,a,d){return c},minWidth:200},{targets:2,data:"mode",render:function(d,c,b,e){if(c==="display"){var a=$("#tempSelMode option[value="+d+"]").attr("selected","selected").parents("#tempSelMode").html();$("#tempSelMode [selected]").removeAttr("selected");return a}return d}},{targets:3,data:"similarity",render:function(c,b,a,d){if(b==="display"){return $("#tempSlide input").attr({value:c,col:d.col,row:d.row}).parent().html()}return c}}],order:[[1,"asc"]],drawCallback:function(a){initLsSlide(null,true,function(c,e){var d=c;if(c.hasClass("ls-slide")){d=c.next("input.ipt-slide")}var b=$(".J-face-com-table").DataTable().cell(d.attr("row"),d.attr("col"));b.data()!==undefined&&b.data()!=e&&b.data(e)});$("tbody input[type='checkbox']").change(function(){$("#chkAll").prop("checked",$("tbody input[type='checkbox']").not(":checked").length===0)})}})}function onFaceCompChChg(){var a=$(this).val();var b=$(this).data("lsat-ch");if(b&&b==a){return}$(this).data("lsat-ch",a);var c=$(".J-face-com-table").DataTable();c.clear().draw();api.faceCompasion(REQUEST_GET,{channel:parseInt(a)},function(d,f){var e={channel:1,base:{enable:true},trigger:{enableBuzzer:true,enableEmail:true,enableRecord:true,enableFullScreen:true,alarmOutChannelMask:"1111"},faceLibList:[{name:"13",similarity:80,mode:1},{name:"10",similarity:80,mode:1},{name:"8",similarity:80,mode:1},{name:"6",similarity:80,mode:1},{name:"4",similarity:80,mode:1},{name:"B",similarity:80,mode:1},{name:"3",similarity:80,mode:1},{name:"a",similarity:80,mode:1},{name:"ghu",similarity:80,mode:1}]};autoFillValue("faceCompasion",e);getVal2Bit("getfacecomparealarmout",e.trigger.alarmOutChannelMask,getDevConf("alarmOutNum"));c.rows.add(e.faceLibList).draw()})}function faceCompSave(){var a=setBit2Val("getfacecomparealarmout",getDevConf("alarmOutNum"))+"";var b=getMatchValue("faceCompasion");b.channel=b.nowChannel;b.trigger.alarmOutChannelMask=a;api.faceCompasion(REQUEST_SET,b,function(c,d){if(c!=CODE_SUCCESS){rightPopup(lang.savedfail);return}rightPopup(lang.saved)})}function getTableData(){var a=[];$(".J-face-com-table").DataTable().rows().every(function(b){var c=$(this.node()).children();a.push([c.eq(1).text(),c.eq(3).find("input").val(),c.eq(0).find("input:checked").length===0?"0":"1",c.eq(2).find("select").val()].join(","))});return a}var faceManageVariables={};var plugin=window.top.plugin;var faceStatus=0;var timeoutflag=null;setConf("faceLibLimit",isXVR()?1:5000);setConf("extraMaxSize",isNVR()?(500*1024):(200*1024));function initSmtFaceManage(){initSimpleTable($("#tabFaceLib"),{columnDefs:[{targets:2,orderable:false,render:function(f,e,d,g){if(e==="display"){return $("#tempDetailBtn").children().attr("lib-idx",g.row).parent().html()}return f}},{targets:3,orderable:false,render:function(f,e,d,g){if(e==="display"){return $("#tempDelFaceBtn").children().attr("lib-idx",g.row).parent().html()}return f}}]});$("body").on("click","#tabFaceLib tbody tr",function(){$("#tabFaceLib tbody tr").removeClass("select");emptyImg($("#imgSelFace"));onFaceLibDetailClk.call($(this).addClass("select").find(".btnLibDetail")[0])}).on("click","#tabFaceLib tbody .btnFaceDel",onDelFaceLibClk);if(isCpuEq("CPU_3531D_16AHD_NRT_6168C_X1")){var a=getCapacity(true);xvr.getVal(a,function(d,g){if(d!=HTTP_OK){rightPopup(lang.optionexception);return}var e=split_span_val_type2(g);var f=e.getnandflashtotalcapacity+"M/"+e.getnandflashfreecapacity+"M";$(".capacity").show();$(".capacity input").val(f)})}if(getConf("isSmtCmpCh")||isXVR()){$("#tabDetail .logNum").after("<td>"+lang.ptzname+"</td>");if(isXVR()){$("#tabDetail .pdname").after("<td>"+lang.featureNum+"</td>")}}$("#tabDetail .pdname").append(getConf("isSmtCmpCh")||isXVR()?lang.coding:(lang.ptzname));initSimpleTable($("#tabDetail"),{columnDefs:[{targets:0,width:100},{targets:getConf("isSmtCmpCh")?3:4,orderable:false,render:function(f,e,d,g){if(e==="display"){return $("#tempDelFaceBtn").children().attr("token",f).parent().html()}return f}}]});$("body").on("click","#tabDetail tbody .btnFaceDel",onDelFaceClk);$("body").on("click","#tabDetail tbody tr",onFaceListSelect);var c={of:$("#stcm"),at:"top+50",my:"top"};setLimitEditStyle($("#iptLibName"),function(d){var e=d.charCodeAt(0);return e>="0".charCodeAt(0)&&e<="9".charCodeAt(0)||e>="a".charCodeAt(0)&&e<="z".charCodeAt(0)||e>="A".charCodeAt(0)&&e<="Z".charCodeAt(0)});$("#dlgAddLid").attr("title",lang.addFaceLib).dialog({autoOpen:false,modal:true,position:c,width:400,resizable:false,draggable:false,open:function(){$("#iptLibName").val("").keyup()},close:function(){},buttons:[{text:lang.confirm,"class":"web-btn btn-confirm",click:function(){plugin().addFaceLib($("#iptLibName").val(),function(d){showSetMsg(d);refreshFaceLibTab()});$(this).dialog("close")}},{text:lang.cancel,"class":"dis",click:function(){$(this).dialog("close")}}]});$("#iptLibName").keyup(function(){$(".btn-confirm").prop("disabled",!$(this).val())});var b=$("#dlgAddDetail").attr("title",lang.addFaceList).dialog({autoOpen:false,modal:true,position:c,width:620,resizable:false,draggable:false,open:function(){clearCanvas();$(this).find("[mode=modeLocal]").click();$("#iptImgPath").val("");$("#btnCapPic,#btnCancelCap,#btnFetchFaceModule").prop("disabled",true);if(isXVR()){var f=$("#tabDetail").DataTable();var d=f.data();var g=$("#selNum").html("");$("<option></option>").val(255).html(lang.addNew).appendTo(g);for(var e=0;e<d.length;++e){$("<option></option>").val(d[e][2]).html(d[e][1]).appendTo(g)}g.data("data-faceName",d);selNumChange()}},close:function(){b.removeClass("modePreview modeLocal")}});$("#dlgAddDetail [name=addType]").click(onAddWayChg);getSmtChBits(function(f,e){var d=getTotalChannelNum();if(f!=HTTP_OK||e.length!==d){rightPopup(lang.optionexception);return}if(getConf("isSmtCmpCh")){faceGetFaceMangeChannal($("#selCh"))}else{initChannelSelect($("#selCh"),d,function(g){return isFaceManageEn(e[g])},0)}$("#selCh").change(onFaceManageChChg)});if(isXVR()){$(".funcLibNum").show()}if(plugin().test){plugin().allStopView();plugin().setPlayWndNum("1","0");plugin().setliveview(DEFAULT_WINDOW);refreshFaceLibTab()}else{$("button,input").prop("disabled",true)}(getConf("isSmtCmpCh"))?$("#dlgAddDetail .addFaceName").show()&&$("#dlgAddDetail .addXvrFaceName").remove():"";isXVR()?$("#dlgAddDetail .addXvrFaceName").show()&&$("#dlgAddDetail .addFaceName").remove():"";setLimitEditStyle($("#addFaceName"),function(d){var e=d.charCodeAt(0);return e>="0".charCodeAt(0)&&e<="9".charCodeAt(0)||e>="a".charCodeAt(0)&&e<="z".charCodeAt(0)||e>="A".charCodeAt(0)&&e<="Z".charCodeAt(0)||!isXVR()&&(e>="\u4e00".charCodeAt(0)&&e<="\u9fa5".charCodeAt(0))});$("#selNum").change(selNumChange)}function refreshFaceLibTab(){loading(true);var a=$("#tabFaceLib").DataTable();a.clear().draw();refreshFaceList();plugin().getFaceLibs(function(d){var c=[];for(var b=0;b<d.length;++b){c.push([d[b]["name"],d[b]["nums"],d[b]["id"],b])}a.rows.add(c).draw();onFaceLibDetailClk.call($("#tabFaceLib tbody tr").first().addClass("select").find(".btnLibDetail")[0]);$("#tabFaceLib").DataTable().row().length>0?$("#btnAddDetail").prop("disabled",false):$("#btnAddDetail").prop("disabled",true);$("#btnAddLib").prop("disabled",isXVR()&&d.length>=getConf("faceLibLimit"));if(isCpuEq("CPU_3531D_16AHD_NRT_6168C_X1")){$("#btnAddLib").prop("disabled",isXVR()&&d.length>=16)}loading(false)})}function refreshFaceList(){var a=$("#tabFaceLib tr.select .btnLibDetail");onFaceLibDetailClk.call(a.length>0?a[0]:this)}function onFaceLibDetailClk(){var c=$("#tabDetail").DataTable();c.clear().draw();emptyImg($("#imgSelFace"));var a=ParseInt($(this).attr("lib-idx"));if(a===undefined){return}var b=$("#tabFaceLib").DataTable().row(a).data();if(b){loading(true);plugin().getFaceListFromLib(b[0],b[2],function(d){var f=[];for(var e=0;e<d.length;e++){if(getConf("isSmtCmpCh")){f.push([e+1,d[e]["name"],d[e]["token"],d[e]["token"]])}else{f.push([e+1,d[e]["name"],d[e]["token"],d[e]["featurenum"],d[e]["token"]])}}$("#tabDetail").attr("data-deList",f);c.clear().draw();c.rows.add(f).draw();$("#btnAddDetail").prop("disabled",false);loading(false)})}}function onDelFaceLibClk(){var a=ParseInt($(this).attr("lib-idx"));var b=$("#tabFaceLib").DataTable().row(a).data();plugin().delFaceLib(b[0],b[2],function(c){showSetMsg(c);refreshFaceLibTab()})}function onFaceListSelect(){loading(true);$("#tabDetail tbody tr").removeClass("select");$(this).addClass("select");var a=$("#tabDetail").DataTable().row(this).data();plugin().getFacePic(a[2],$("#tabFaceLib tr.select td").eq(0).html(),function(b){$("#imgSelFace").attr("src",b);loading(false)})}$("#btnFetchFaceModule").click(function(){if(timeoutflag!=null){clearTimeout(timeoutflag)}timeoutflag=setTimeout(function(){onBtnExtraPicClk()},250)});function onBtnExtraPicClk(){xvr.getPlayBackStatus(function(a,d){if(a!=HTTP_OK){rightPopup(lang.optionexception);return}var c=splitOkVal(d);faceStatus=c.getpbstatus;if(parseInt(faceStatus)){rightPopup(lang.ExtractFaceTip);return}setImgData("",$("#cav2"));$("#cav2").show();var b=function(e,f){loading(false);if(e){setImgData(e,$("#cav2"))}else{if(f&&(f.left||f.top||f.right||f.bottom)){f.left=f.left/10000;f.top=f.top/10000;f.right=f.right/10000;f.bottom=f.bottom/10000;$("#cav2").data("meta",f);setImgData($("#cav1").data("img-data"),$("#cav2"),f.left,f.top,f.right,f.bottom)}else{alert(lang.getPrmFailed)}}};if($("#dlgAddDetail").hasClass("modePreview")&&$("#btnCancelCap").prop("disabled")){onBtnCapClk(function(e){if(e){loading(true);if(!plugin().extraFacePicFromLocal(e,b,isXVR(),getConf("extraMaxSize"))){b("")}}})}else{loading(true);if(!plugin().extraFacePicFromLocal(getExtraImg(),b,isXVR(),getConf("extraMaxSize"))){b("")}}})}function onAddFaceConfirmClk(){var b=$("#cav2");var d=b.data("img-data");if(isXVR()&&$("#addFaceName").val()==""){rightPopup(lang.noNameTip);return}if(d){var f=function(h){rightPopup(h?lang.setsuccessfully:(getConf("isSmtCmpCh")?lang.savedfail:lang.faceLimit));refreshFaceList()};var g=b.data("meta");g||(g={});var c=getSelFaceLibData();if(isXVR()){var e=$("#cavData");var a=$("#addFaceName").val();setImgData($("#cav1").data("img-data"),e,g.left,g.top,g.right,g.bottom,true,function(){d=e[0].toDataURL("image/jpeg",0.8);g.token=ParseInt($("#selNum").val());isXVR()?plugin().addFace2Lib(c[0],c[2],g,d,f,a,isXVR(),getNewVersion()):plugin().addFace2Lib(c[0],c[2],g,d,f)})}else{var a=$("#addFaceName").val();if(getConf("isSmtCmpCh")){plugin().addFace2Lib(c[0],c[2],g,d,f,a)}}$("#dlgAddDetail").dialog("close");$("#addFaceName").val("")}else{alert(lang.getPrmFailed)}}function getNewVersion(){var b="20.1.3.200114";var a=versionconfig.web_version.split(".").join("");if(parseInt(a)>=parseInt(b.split(".").join(""))){return true}else{return false}}function onAddFaceCancelClk(){$("#dlgAddDetail").dialog("close")}function onDelFaceClk(){if(!confirm(lang.confirmDel)){return}var a=$(this).attr("token");plugin().delFaceFromLib(a,$("#tabFaceLib tr.select td").eq(0).text(),function(b){showSetMsg(b);refreshFaceList()})}function onBroweLocalImgClk(){var a=plugin().brwoseFileName(3);$("#btnFetchFaceModule").prop("disabled",a?false:true);if(a){$("#iptImgPath").val(a);plugin().getPicBase64({localPic:a},function(b){$("#cav1").data("img-data",b);setImgData(b)})}else{clearCanvas()}}function getSelFaceLibData(){return $("#tabFaceLib").DataTable().row($("#tabFaceLib tr.select")).data()}function onAddLibClk(){$("#dlgAddLid").dialog("open")}function onAddDetialClk(){$("#dlgAddDetail").addClass($(this).attr("mode")).dialog("open")}function onAddWayChg(){var a=$(this).attr("mode");$("#dlgAddDetail").removeClass("modeLocal modePreview").addClass(a);clearCanvas();eventresize(false,$("#cav1"));$("#btnFetchFaceModule").prop("disabled",true);if(a==="modeLocal"){$("#btnCapPic,#btnCancelCap").prop("disabled",true);plugin().allStopView()}else{$("#btnCapPic").prop("disabled",false);$("#btnCancelCap").prop("disabled",true);$("#selCh").val($("#selCh option").val()).change()}}function onFaceManageChChg(){var a=$(this).val();if(a===null){return}if(checkPluginInstall()){plugin().startview(getHost(),getDevConf("rtspPort"),getUserName(),loginpsw,1,a)}onBtnCancelCapClk()}function onBtnCapClk(a){$("#btnCapPic").prop("disabled",true);$("#btnCancelCap").prop("disabled",false);plugin().getCapOnWnd(function(c){var b="";$("#btnFetchFaceModule").prop("disabled",c?false:true);if(c){setImgData(c);$("#cav1").data("img-data",c)}a&&a("data:image/jpg;base64,"+c)})}function onBtnCancelCapClk(){eventresize(false,$("#cav1"));$("#btnCapPic").prop("disabled",false);$("#btnFetchFaceModule").prop("disabled",true);$("#btnCancelCap").prop("disabled",true);clearCanvas();$("#cav2").hide()}function setImgData(h,b,e,d,i,j,a,f){b||(b=$("#cav1"));var g=b[0].getContext("2d");if(h){var c=new Image();c.src=h;c.onload=function(){e||(e=0);d||(d=0);i||(i=1);j||(j=1);var t=c.width*e,o=c.height*d,p=c.width*i-t,q=c.height*j-o;var m=b.width(),l=b.height(),s=0,n=0;if(a){b[0].width=p;b[0].height=q;m=p;l=q}else{var k=m/l,r=p/q;if(k>r){m=r*l;s=(b.width()-m)/2}else{if(k<r){l=m/r;n=(b.height()-l)/2}}}g.clearRect(0,0,b.width(),b.height());g.drawImage(c,t,o,p,q,s,n,m,l);b.data("img-data",h);f&&f()}}else{g.clearRect(0,0,b.width(),b.height());b.data("img-data","")}}function getExtraImg(){return $("#cav1").data("img-data")}function clearCanvas(){setImgData("",$("#cav1"));setImgData("",$("#cav2"));$("#iptImgPath").val("")}function onBtnAddFaceName(){$("#btnAddFaceName").dialog("open")}function selNumChange(){if($("#selNum").val()=="255"){$("#addFaceName").prop("disabled",false);$("#addFaceName").val("")}else{$("#addFaceName").prop("disabled",true);var a=$(this).val();$("#addFaceName").val($("#selNum").data("data-faceName")[a-1][1])}}function getSmtChBits(a){xvr.getVal(["getchfunc"],function(j,h){if(j!=200){a(j,h)}else{var g=splitOkVal(h);var d=getTotalChannelNum();var b=Array();if(g.getchfunc){var f=g.getchfunc.split(";");for(var e=0;e<d;++e){b.push(ParseInt(f[e])||0)}}a(j,b)}})}function isHumanEn(a){return(a&BIT_FACE_HUMAN)!==0}function isFaceEn(a){return(a&BIT_FACE_DETECT)!==0}function isCrossEn(a){return(a&BIT_CROSS_DETECT)!==0}function isBlockEn(a){return(a&BIT_BLOCK_INVADE)!==0}function isHoverEn(a){return(a&BIT_HOVER_DETECT)!==0}function isGatherEn(a){return(a&BIT_GATHER_DETECT)!==0}function isFaceCmpEn(a){return(a&BIT_FACE_COMPARE)!==0}function isFaceManageEn(a){return(a&BIT_FACE_MANAGE)!==0};