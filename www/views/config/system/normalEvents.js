var motionVariables={beDraw:false,IsInstalled:false,cpuType:getDevConf("platformType"),isScheduleEn:isXVR()||(isNVR()&&(getDevConf("platformType")==3||getDevConf("platformType")==8||getDevConf("platformType")==9||getDevConf("platformType")==11||getDevConf("platformType")==12||getDevConf("platformType")==21||getDevConf("platformType")==30||getDevConf("platformType")==40)),wsId:0};var exceptionVariables={beSelectType:0};var videoLossVariables={beSelectType:0,channalNum:getTotalChannelNum(),cpuType:getDevConf("platformType")};function onLoad(){initDot();bindTagHead();listenEvents();initException();initVideoLoss();initBuzzer();initRecSetEx();initMotion()}function onUnload(){$(".J-motion-channel").data("last-ch")!==undefined&&$("#videoBlock").isPlayer("stopPreview",$(".J-motion-channel").data("last-ch"));$("#videoBlock").isPlayer("destroy")}function initMotion(){setTitle(lang.motionDetecting);initVideoPlug();$(".J-motion-tabs").tabs();setConf("isCoverSche1",isNVR());getConf("motionLinkageEn")&&$('[matchval="getmotiondetlinkage"]').parents(".form-item").eq(0).show();initChannelSelect($(".J-motion-channel"),getEnbChNum(getTotalChannelNum()),isChEnb,0);if(!$(".J-motion-channel").val()){rightPopup(lang.nolimit);return}if(getConf("removeBuzzer")){$(".J-beep-enable").attr("disabled",true)}setEditNumberStyle(".J-beep-time");setEditNumberStyle(".J-record-time");if(motionVariables.isScheduleEn){$(".J-sched-date").show()}initCheckbox($(".J-motion-alarm-out span").eq(1),getConf("isNvrAlarmOutEn"),"alarmOutRecord");$(".J-motion-channel").change(motionLoad).change();$(".J-motion-alarm-out").find("span").eq(1).after("");if(getConf("isNvrAlarmOutEn")==0){$(".J-motion-alarm-out").hide()}if(getConf("nvrNew")){$(".J-motion-alarm-out").removeClass("hide")}eventresize()}function initVideoPlug(){$("#videoBlock").isPlayer({isConfigVideo:true});if(checkPluginInstall()){var a=$("#videoBlock");var b=detectZoom();a.isPlayer("setPluginPosition",String(ParseInt(a.width()*b)),String(ParseInt(a.height()*b)));a.isPlayer("initVideoWindow",getDeviceValue());a.isPlayer("stopAllVideo");a.isPlayer("setPlayWindowNum",2);a.isPlayer("setWindowType",3);motionVariables.IsInstalled=true}else{motionVariables.IsInstalled=false}}function startVideo(){var d=$(".J-motion-channel");var c=d.val();var b=$("#videoBlock");var a=d.data("last-ch");a!==undefined&&b.isPlayer("stopPreview",a);d.data("last-ch",c);if(checkPluginInstall()){if(window.top.nLiveviewDatabit[c]){b.isPlayer("setHttpPort").isPlayer("startPreview",1,c)}}else{$("#videoBlock>.J-plugin-block").html("");var e=function(){configPurePlay(c,null,a,motionVariables.wsId);motionVariables.wsId++};getPlayEncodeInfo(c,e,true)}}function fmtSchedule(j,f,d){var c=j.attr("id");var k=c.substr(-5,4)==="hour";var h=$("#"+(k?c.substr(0,c.lastIndexOf("hour"))+"min"+c.substr(-1):c.substr(0,c.lastIndexOf("min"))+"hour"+c.substr(-1)));var g=k?j:h,l=k?h:j;if(g.val()=="24"){l.val("0")}var e=0,i=0;var b=c.substr("getmotionschedis".length,"start".length)==="start";var a=j.parents(".form-item").find("input[type='text']");if(b){e=g.val()*60+parseInt(l.val());i=a.eq(2).val()*60+parseInt(a.eq(3).val())}else{e=a.eq(0).val()*60+parseInt(a.eq(1).val());i=g.val()*60+parseInt(l.val())}if(b&&e>i){a.eq(2).val(g.val());a.eq(3).val(l.val())}else{if(!b&&i<e){a.eq(0).val(g.val());a.eq(1).val(l.val())}}}function motionDraw(){var a=$("#videoBlock");var b=!motionVariables.bDrawIng?"1":"0";if(motionVariables.IsInstalled){a.isPlayer("setMotionDraw",b)}if(!motionVariables.bDrawIng){$(".J-draw-btn>span>label").text(lang.stopdraw);if(!motionVariables.IsInstalled){$("#videoBlock").isPlayer("setMDBlkSize",MD_BLK_NUM_X,MD_BLK_NUM_Y);onBtnMDClk(1)}}else{$(".J-draw-btn>span>label").text(lang.drawrect);!motionVariables.IsInstalled&&$("#videoBlock").find("canvas.draw-box").off("mousedown").off("mouseup").off("mouseout")}motionVariables.bDrawIng=!motionVariables.bDrawIng}function clearAllRegion(){var b=$("#videoBlock");if(motionVariables.IsInstalled){b.isPlayer("delMotionAllDraw",0)}else{var c=$("#videoBlock").data("md-data");for(var a=0;a<c.area.length;a++){c.area[a]=0}$("#videoBlock").data("md-data",c);onBtnMDClk(0)}}function onBtnMDClk(e){var a=new Array(MD_BLK_NUM_X*MD_BLK_NUM_Y);if(e==0){for(var c=a.length-1;c>=0;c--){a[c]=e}}else{var d=$("#videoBlock").data("md-data");for(var c=0;c<MD_BLK_NUM_X;++c){for(var b=0;b<MD_BLK_NUM_Y;++b){a[b*MD_BLK_NUM_X+c]=(ParseInt(d.area[b])&(1<<c))!==0?1:0}}}$("#videoBlock").isPlayer("doMDDraw",a,true)}function initRecSetEx(){var a=initChannelSelect($(".J-motion-channel"),getTotalChannelNum(),function(b){return window.top.nRecordDatabit[b]==1&&isChEn(b)},1);setConf("isMoreStEn",isNVR()||isXVR());window.g_arrCate=[{name:lang.recordTime,color:"rgb(66, 175, 46)",disabled:false}];window.g_mapCate={};window.g_mapCate[RECORD_TYPE_NORMAL]=window.g_arrCate[0];initCommSche($("#divTimeSel"),window.g_arrCate);if(a==0){rightPopup(lang.nolimit);$(".J-motion-save").attr("disabled",true);return}if(getConf("isMoreStEn")){$("#btnMoreSetting").show();$("#dlgMoreSetting").attr("title",lang.more)}if(getConf("nvrNew")){$("#recchanenable").removeClass("hide");$(".dlgMoreSetting").eq(1).removeClass("hide")}else{$("#recchanenable").addClass("hide");$(".dlgMoreSetting").eq(1).addClass("hide")}}function onBtnDelAllClk(a){$("#divTimeSel").timeSegSelect("clearAll").find(".btnDel").prop("disabled",true)}function getWeekSegNum(f){var e=$("#divTimeSel");var b={},h=0;for(var g in window.g_mapCate){g=ParseInt(g);var a=e.timeSegSelect("getCateTimeData",f,window.g_mapCate[g]["name"]);for(var c=0;c<a.length;++c){var d=a[c][0]+"-"+a[c][1];if(!b[d]){b[d]=1;++h}}}return h}function motionLoad(){$("#videoBlock").isPlayer("setMDBlkSize",MD_BLK_NUM_X,MD_BLK_NUM_Y);$(".J-draw-btn>span>label").text(lang.drawrect);loading(true);var a=$("#divTimeSel");onBtnDelAllClk();var b=ParseInt($(".J-motion-channel").val());api.eventMotion(REQUEST_GET,{channel:b},function(f,g){loading(false);if(f==0){autoFillValue("motion",g);$(".slide").slider({min:g.base.sensitivityMin,max:g.base.sensitivityMax,value:$(".J-sensitivity").val(),slide:function(h,i){$(".J-sensitivity").val(i.value)}});getVal2Bit("alarmOutRecord",g.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"));setTimeout(function(){if(motionVariables.IsInstalled){var h=$("#videoBlock");clearAllRegion();if(num==250){num=0}var i=g.area.toString().replace(/,/g,";")+";";h.isPlayer("setMotionData",b,i)}else{$("#videoBlock").isPlayer("setMDBlkSize",MD_BLK_NUM_X,MD_BLK_NUM_Y);setMDBlkData(g)}},1000);var c=g.schedTime;for(var d=0;d<c.length;++d){for(var e=0;e<c[d].oneDay.length;++e){beginTime=c[d].oneDay[e].startTime/60;endTime=c[d].oneDay[e].endTime/60;if(beginTime===0&&endTime===0){continue}recordType=window.g_mapCate[RECORD_TYPE_NORMAL].name;a.timeSegSelect("addCateTimeData",d,recordType,beginTime,endTime)}}startVideo()}})}function setMDBlkData(d){var a=new Array(MD_BLK_NUM_X*MD_BLK_NUM_Y);for(var c=0;c<MD_BLK_NUM_X;++c){for(var b=0;b<MD_BLK_NUM_Y;++b){a[b*MD_BLK_NUM_X+c]=(ParseInt(d.area[b])&(1<<c))!==0?1:0}}$("#videoBlock").data("md-data",d);$("#videoBlock").isPlayer("doMDDraw",a,true);$("#videoBlock").find("canvas.draw-box").off("mousedown").off("mouseup").off("mouseout")}function getMDBlkData(){var b=$("#videoBlock").data("md-data");for(var d=0;d<b.area.length;++d){b.area[d]=0}var a=$("#videoBlock").isPlayer("getMotionData");for(var d=0;d<MD_BLK_NUM_X;++d){for(var c=0;c<MD_BLK_NUM_Y;++c){a[c*MD_BLK_NUM_X+d]==1&&(b.area[c]|=(1<<d))}}for(var d=0;d<b.area.length;d++){b.area[d]=b.area[d]+""}return b}function recType2name(a){a=ParseInt(a);return window.g_mapCate[a]?window.g_mapCate[a]["name"]:window.g_mapCate[RECORD_TYPE_NORMAL]["name"]}function onSaveSegClk(){var c=$("#divTimeSel");var j=c.find(".btnDel");var g=$(".J-time-popup-block div.J-check-type input:checked").not(".J-check-all");var e=$(".J-time-popup-block div.J-time-edit input");var k=e.eq(0).val()*60+ParseInt(e.eq(1).val()),h=e.eq(2).val()*60+ParseInt(e.eq(3).val()),b=ParseInt(j.attr("w"));if(k>=h){rightPopup(lang.setTimeTips2);return}c.timeSegSelect("backup");var f=false;for(var d=0;d<g.length;++d){var a=g.eq(d).attr("name");c.timeSegSelect("delCateTimeData",b,a,j.attr("i"));c.timeSegSelect("addCateTimeData",b,a,k,h)}if(getWeekSegNum(b)>MAX_SEG_NUM){rightPopup(lang.tipSegOverflow);c.timeSegSelect("rollback");return}g.length==0?"":rightPopup(lang.saved);$(".J-time-popup-block").hide();motionSave()}function motionSave(){var d=getValidRecData();var a=$("#videoBlock");if(!d){rightPopup(lang.recinvalidsce);return}var c=getMatchValue("motion");var b=[];if(checkPluginInstall()){b=a.isPlayer("getMotionData",c.nowChannel);b=b.split(";");b.splice(-1,1)}else{b=getMDBlkData().area}c.trigger.alarmOutChannelMask=setBit2Val("alarmOutRecord",getConf("isNvrAlarmOutEn"))+"";var e={channel:c.nowChannel,base:c.base,trigger:c.trigger,area:b,schedTime:getSchedTime(d)};api.eventMotion(REQUEST_SET,e,function(f,g){loading(false);rightPopup(f==0?lang.saved:lang.savedfail)})}function getValidRecData(m){var g=new Array(7);var a=$("#divTimeSel");for(var b=0;b<7;++b){g[b]={};for(var f in window.g_mapCate){f=ParseInt(f);var l=a.timeSegSelect("getCateTimeData",b,window.g_mapCate[f]["name"]);for(var d=0;d<l.length;++d){var i=l[d][0]+"-"+l[d][1];if(g[b][i]){g[b][i]["type"]|=f}else{if(mapSize(g[b])>=MAX_SEG_NUM){return null}else{g[b][i]={type:f,time:l[d]}}}}}}if(m){return true}var e=new Array(7);for(var h=0;h<g.length;++h){e[h]=[];for(var c in g[h]){g[h][c];e[h].push({type:g[h][c]["type"],sHour:Math.floor(g[h][c]["time"][0]/60),sMin:g[h][c]["time"][0]%60,eHour:Math.floor(g[h][c]["time"][1]/60),eMin:g[h][c]["time"][1]%60})}}return e}function onDelSegClk(){$("#divTimeSel .btnDel").click();$(".J-time-popup-block").hide()}function onExceptionLoad(){$("#videoBlock").isPlayer("destroy");loadExceptionSetting(0)}function initException(){setTitle(lang.optionexception);setConf("isScreenDisplayEn",isXVR()||isNVR());getConf("isScreenDisplayEn")&&$("#normalLink4").show();if(getConf("nvrNew")){$("#alarmLink").removeClass("hide");initCheckbox($(".J-exception-alarm-out div"),getConf("isNvrAlarmOutEn"),"geteventalarmout",true)}if(getConf("removeBuzzer")){$(".J-buzzer-alarm").hide()}$(".J-event-type").change(function(){if(exceptionVariables.beSelectType==0){loadExceptionSetting($(this).val())}else{var a=$(this).val();if(browserCfg.safari){if(a==0){a=2}else{if(a==1){a=3}}}loadExceptionSetting(a)}})}function setExceptionData(){var a;if(exceptionVariables.beSelectType==0){a=$(".J-event-type").val()}else{var d=$(".J-event-type").val();if(browserCfg.safari){if(d==0){d=2}else{if(d==1){d=3}}}a=d}var c=setBit2Val("geteventalarmout",getConf("isNvrAlarmOutEn"))+"";var b=getMatchValue("exception");b.trigger.alarmOutChannelMask=c;b.eventType=parseInt(a);api.exception(REQUEST_SET,b,function(e,f){if(e!=CODE_SUCCESS){return}rightPopup(lang.saved)})}function loadExceptionSetting(a){api.exception(REQUEST_GET,{eventType:parseInt(a)},function(b,c){if(b!=CODE_SUCCESS){return}autoFillValue("exception",c);if(c.trigger.alarmOutChannelMask){getVal2Bit("geteventalarmout",c.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"))}})}function exceptionNormalLinkAll(){if($(".J-ex-check-all").is(":checked")){$("#geteventenalbe").prop("checked",true);$("#geteventemail").prop("checked",true);$("#geteventbuzzer").prop("checked",true);$("#geteventdisplay").prop("checked",true)}else{$("#geteventenalbe").prop("checked",false);$("#geteventemail").prop("checked",false);$("#geteventbuzzer").prop("checked",false);$("#geteventdisplay").prop("checked",false)}}function alarmNormalLinkAll(){if($("#geteventalarmouten").is(":checked")){$(".divBlock").find("input").prop("checked",true)}else{$(".divBlock").find("input").prop("checked",false)}}function onVideoLossLoad(){$("#videoBlock").isPlayer("destroy");loadVideoLossSetting(0)}function initVideoLoss(){setTitle(lang.videoloss);if(getConf("nvrNew")){$("#videoAlarmLink").removeClass("hide");initCheckbox($(".J-video-lose-alarm-out div"),getConf("isNvrAlarmOutEn"),"getvediolossalarmoutEx",true)}if(getConf("removeBuzzer")){$(".J-buzzer-alarm").hide()}for(var a=0;a<videoLossVariables.channalNum;a++){if((window.top.vChannelConfig[a]<=1||isNVR())&&window.top.nSynConfigDatabit[0]){loadVideoLossSetting(a);break}}getVideoLossChn(videoLossVariables.channalNum);$(".J-video-loss-channel").change(function(){var b=$(this).val();$("#LinkAllCheck").prop("checked",false);if(b>=0){if(b!=videoLossVariables.beSelectType){loadVideoLossSetting($(this).val());videoLossVariables.beSelectType=b}}})}function getVideoLossChn(c){if(isNVR()){initChannelSelect($(".J-video-loss-channel"),getTotalChannelNum(),function(g){return window.top.nSynConfigDatabit[0]});if($(".J-video-loss-channel option").length==getTotalChannelNum()){$(".J-video-loss-channel").prepend($("<option value='250' >"+window.top.lang.allchannel+"</option>"))}return}var e="";var b=0;var a=0;for(var d=1;d<=c;d++){if(window.top.vChannelConfig[d-1]<=1){a++}}for(var d=1;d<=c;d++){if(window.top.vChannelConfig[d-1]<=1&&window.top.nSynConfigDatabit[0]){b++}}var f=0;for(var d=1;d<=c;d++){if(window.top.vChannelConfig[d-1]<=1&&window.top.nSynConfigDatabit[0]){e=d>9?"":"0";f++;if(f==1){$("<option value='"+(d-1)+"' selected='selected' >CH"+e+d+"</option>").appendTo($(".J-video-loss-channel"))}else{$("<option value='"+(d-1)+"' >CH"+e+d+"</option>").appendTo($(".J-video-loss-channel"))}}}if(parseInt(b)==parseInt(a)&&b!=0){$(".J-video-loss-channel").prepend($("<option value='250' >"+window.top.lang.allchannel+"</option>"))}}function videoLossSave(){if($(".J-video-loss-channel").val()==null){rightPopup(lang.nolimit);return}var b=setBit2Val("getvediolossalarmoutEx",getConf("isNvrAlarmOutEn"))+"";var a=getMatchValue("videoLoss");a.channel=parseInt($(".J-video-loss-channel").val());a.trigger.alarmOutChannelMask=b;api.videoLoss(REQUEST_SET,a,function(c,d){if(c!=CODE_SUCCESS){return}rightPopup(lang.saved)})}function loadVideoLossSetting(a){api.videoLoss(REQUEST_GET,{channel:parseInt(a)},function(b,c){if(b!=CODE_SUCCESS){return}autoFillValue("videoLoss",c);if(c.trigger.alarmOutChannelMask){getVal2Bit("getvediolossalarmoutEx",c.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"))}})}function normalLinkAll(){if($("#LinkAllCheck").is(":checked")){$("#getvediolossenalbe").prop("checked",true);if(parseInt(getDevConf("alarmOutNum"))===1){$("#getvediolossalarmout0").prop("checked",true)}if(parseInt(getDevConf("alarmOutNum"))===4){$("#getvediolossalarmout0").prop("checked",true);$("#getvediolossalarmout1").prop("checked",true);$("#getvediolossalarmout2").prop("checked",true);$("#getvediolossalarmout3").prop("checked",true)}$("#getvediolossdisplay").prop("checked",true);$("#getvediolossemail").prop("checked",true);$("#getvediolossbuzzer").prop("checked",true)}else{$("#getvediolossenalbe").prop("checked",false);if(parseInt(getDevConf("alarmOutNum"))===1){$("#getvediolossalarmout0").prop("checked",false)}if(parseInt(getDevConf("alarmOutNum"))===4){$("#getvediolossalarmout0").prop("checked",false);$("#getvediolossalarmout1").prop("checked",false);$("#getvediolossalarmout2").prop("checked",false);$("#getvediolossalarmout3").prop("checked",false)}$("#getvediolossdisplay").prop("checked",false);$("#getvediolossemail").prop("checked",false);$("#getvediolossbuzzer").prop("checked",false)}}function vedioLossAlarmNormalLinkAll(){if($("#getvediolossalarmout").is(":checked")){$(".J-video-lose-alarm-out").find("input").prop("checked",true)}else{$(".J-video-lose-alarm-out").find("input").prop("checked",false)}}function onBuzzerLoad(){$("#videoBlock").isPlayer("destroy");loadBuzzerSetting()}function initBuzzer(){setTitle(lang.eventBuzzer);setEditNumberStyle(".J-buzzer-dalay-time")}function buzzerSave(){api.buzzer(REQUEST_SET,getMatchValue("buzzer"),showSaveMsg)}function loadBuzzerSetting(){api.buzzer(REQUEST_GET,null,function(a,b){if(a!=CODE_SUCCESS){rightPopup(lang.optionexception);return}autoFillValue("buzzer",b);if(b.delayTime==0){$(".J-buzzer-dalay-time").val(1)}})}function listenEvents(){$(".J-buzzer-save").on("click",buzzerSave);$(".J-motion-save").on("click",motionSave);$(".J-draw-btn").on("click",motionDraw);$(".J-clear-btn").on("click",clearAllRegion)};