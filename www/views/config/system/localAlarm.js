var alarmVariables={timeSeg:null,channelNum:getTotalChannelNum(),channelSel:0};function onLoad(){initDot();setTitle(lang.localalarm);initAlarmIn();initAlarmOut();listenEvents();bindTagHead()}function initAlarmIn(){if(getConf("isNvrAlarmOutEn")){$(".getalarminout").show();addHeight("getalarminout",getConf("isNvrAlarmOutEn"));initCheckbox($(".getalarminout span").eq(1),getConf("isNvrAlarmOutEn"),"getalarminout")}if(getConf("alarmOutNum")){addHeight("alarmInRecord",alarmVariables.channelNum);initCheckbox($(".J-in-record-block span").eq(1),(isXVR()?getEnbChNum(alarmVariables.channelNum):alarmVariables.channelNum),"alarmInRecord")}if(getConf("alarmOutNum")){addHeight("alarmInFullScr",alarmVariables.channelNum);initCheckbox($(".J-in-full-screenen span").eq(1),(isXVR()?getEnbChNum(alarmVariables.channelNum):alarmVariables.channelNum),"alarmInFullScr")}if(getConf("alarmLinkageEn")){var a=getEnbChNum(alarmVariables.channelNum);$selList=$('[matchval="getalarminlinkage');$selList.parents(".form-item").eq(0).show();for(var b=1;b<=a;++b){$("<option></option>").val(b-1).html(lang.chAbbr+("0"+b).substr(-2)).appendTo($selList)}}setLimitEditStyle($(".J-alarm-in-name"),function(c){return checkCharValid(c,1)});if(isXVR()){$(".J-in-full-screenen .width50").find("input[type=checkbox]").bind("click",function(){$(".J-in-full-screenen .width50").find("input[type=checkbox]").not(this).attr("checked",false)})}initAlarmInNum()}function initAlarmInNum(){var a=getDevConf("alarmInNum");for(var b=0;b<a;b++){$(".J-in-channel").append('<option value="'+b+'">'+(b+1)+"</option>")}if(a==0){rightPopup(lang.nolimit);return}$(".J-xvr-fullScreen").hide()}function recordAll(){var c=$(".J-in-record-block").find(".width50").length;var a=$(".J-all-record-in").is(":checked");for(var b=0;b<c;b++){$("#alarmInRecord"+b).prop("checked",a)}}function fullScreenSetAll(){var c=$(".J-in-full-screenen").find(".width50").length;var a=$(".J-all-fullscreen-in").is(":checked");for(var b=0;b<c;b++){$("#alarmInFullScr"+b).prop("checked",a)}}function addHeight(c,a){var b=a/16;$("."+c).css("height",35*b+"px")}function get64Val2Bit(h,f,e){var b=bases.fromBase(f,10);var d=bases.toBase(b,2);var g=d.split("");g=g.reverse();for(var c=0;c<e;c++){var a=$("#"+h+c);a.prop("checked",false);if(g[c]>=1){a.click();a.prop("checked",true)}}}function set2Bit64Val(g,d){var c=[];if(!d){return 0}for(var b=0;b<d;b++){var a=$("[matchval='"+g+b+"']");c.push(a.prop("checked")?"1":"0")}c=c.reverse();var f=c.join("").toString();var h=bases.fromBase(f,2);var e=bases.toBase(h,10);return e}function loadAlarmIn(a){api.alarmIn(REQUEST_GET,{channel:parseInt(a)},function(b,h){if(b!=CODE_SUCCESS){return}autoFillValue("alarmIn",h);getVal2Bit("getalarminout",h.trigger.alarmOutChannelMask,getConf("isNvrAlarmOutEn"));if(alarmVariables.channelNum<54){getVal2Bit("alarmInRecord",h.trigger.recordChannelMask,alarmVariables.channelNum);getVal2Bit("alarmInFullScr",h.trigger.fullScreenChannelMask,alarmVariables.channelNum)}else{get64Val2Bit("alarmInRecord",h.trigger.recordChannelMask,alarmVariables.channelNum);get64Val2Bit("alarmInFullScr",h.trigger.fullScreenChannelMask,alarmVariables.channelNum)}var c=h.schedTime,f=0,l=0,d=window.g_mapCate[RECORD_TYPE_NORMAL].name,k=alarmVariables.timeSeg.find(".J-time-sel");onBtnDelAllClk();for(var e=0;e<c.length;++e){for(var g=0;g<c[e].oneDay.length;++g){f=c[e].oneDay[g].startTime/60;l=c[e].oneDay[g].endTime/60;if(f===0&&l===0){continue}k.timeSegSelect("addCateTimeData",e,d,f,l)}}})}function initRecSetEx(){var b=initChannelSelect($("#getAlarmInSchedchn"),alarmVariables.channelNum,function(g){return window.top.nRecordDatabit[g]==1&&isChEn(g)},1);setConf("isMoreStEn",isNVR()||isXVR());window.g_arrCate=[{name:lang.recordTime,color:"rgb(66, 175, 46)",disabled:false}];window.g_mapCate={};window.g_mapCate[RECORD_TYPE_NORMAL]=window.g_arrCate[0];initCommSche(alarmVariables.timeSeg.find(".J-time-sel"),window.g_arrCate);var a=alarmVariables.timeSeg.find(".J-check-type table");var d=a.find("tr");var f=function(g){return'<label><input type="checkbox" name="'+g+'"/>'+g+"</label>"};d.find("td:last").html(f(window.g_arrCate[0].name));for(var c=1;c<window.g_arrCate.length;c+=2){var e=d.clone();e.find("td").eq(0).html(f(window.g_arrCate[c].name)).end().eq(1).html(f(window.g_arrCate[c+1].name)).end().parent().appendTo(a)}if(b==0){rightPopup(lang.nolimit);$("#btnRecSave").attr("disabled",true);return}alarmVariables.timeSeg.find(".J-close-popup").click(function(){alarmVariables.timeSeg.find(".J-time-popup-block").hide()})}function onBtnDelAllClk(a){alarmVariables.timeSeg.find(".J-time-sel").timeSegSelect("clearAll").find(".btnDel").prop("disabled",true)}function getWeekSegNum(e){var b=alarmVariables.timeSeg.find(".J-time-sel");var a={},g=0;for(var f in window.g_mapCate){f=ParseInt(f);var h=b.timeSegSelect("getCateTimeData",e,window.g_mapCate[f].name);for(var c=0;c<h.length;++c){var d=h[c][0]+"-"+h[c][1];if(!a[d]){a[d]=1;++g}}}return g}function recType2name(a){a=ParseInt(a);return window.g_mapCate[a]?window.g_mapCate[a].name:window.g_mapCate[RECORD_TYPE_NORMAL].name}function onSaveSegClk(){var j=alarmVariables.timeSeg.find(".J-time-sel");var k=j.find(".btnDel");var a=$(".J-check-type input:checked").not(".J-check-all");var d=alarmVariables.timeSeg.find(".J-time-edit input");var e=d.eq(0).val()*60+ParseInt(d.eq(1).val()),g=d.eq(2).val()*60+ParseInt(d.eq(3).val()),c=ParseInt(k.attr("w"));if(e>=g){rightPopup(lang.setTimeTips2);return}j.timeSegSelect("backup");for(var f=0;f<a.length;++f){var b=a.eq(f).attr("name");j.timeSegSelect("delCateTimeData",c,b,k.attr("i"));j.timeSegSelect("addCateTimeData",c,b,e,g)}if(getWeekSegNum(c)>MAX_SEG_NUM){rightPopup(lang.tipSegOverflow);j.timeSegSelect("rollback");return}a.length==0?"":rightPopup(lang.saved);alarmVariables.timeSeg.find(".J-time-popup-block").hide();var h=alarmVariables.timeSeg.selector==".J-time-alarm-in";h?alarmInSave():alarmOutSave()}function getValidRecData(m){var g=new Array(7);var h=alarmVariables.timeSeg.find(".J-time-sel");for(var a=0;a<7;++a){g[a]={};for(var f in window.g_mapCate){f=ParseInt(f);var e=h.timeSegSelect("getCateTimeData",a,window.g_mapCate[f].name);for(var c=0;c<e.length;++c){var l=e[c][0]+"-"+e[c][1];if(g[a][l]){g[a][l].type|=f}else{if(mapSize(g[a])>=MAX_SEG_NUM){return null}else{g[a][l]={type:f,time:e[c]}}}}}}if(m){return true}var d=new Array(7);for(var i=0;i<g.length;++i){d[i]=[];for(var b in g[i]){g[i][b];d[i].push({type:g[i][b].type,sHour:Math.floor(g[i][b].time[0]/60),sMin:g[i][b].time[0]%60,eHour:Math.floor(g[i][b].time[1]/60),eMin:g[i][b].time[1]%60})}}return d}function onDelSegClk(){alarmVariables.timeSeg.find(".J-time-sel .btnDel").click();alarmVariables.timeSeg.find(".J-time-popup-block").hide()}function initDelayTime(){var b=[5,10,30,60,120,300,600,0],a=[];for(var c=0;c<b.length;c++){var d="",e="";if(b[c]>=60){d=b[c]/60;e=lang.dst4}else{d=b[c];e="s"}b[c]!=0?a.push({val:b[c],name:d+e}):a.push({val:b[c],name:lang.pswClear})}return a}function initAlarmOut(){setTitle(lang.localalarm);var a=getConf("isNvrAlarmOutEn");var c=true;for(var b=0;b<a;b++){if(window.top.nSynConfigDatabit[63]!=0||!isNVR()){$(".J-out-channel").append('<option value="'+b+'">'+(b+1)+"</option>");c=false}}if(c){rightPopup(lang.nolimit);return}setLimitEditStyle($(".J-alarm-out-name"),function(d){return checkCharValid(d,1)});$(".J-out-channel").change(function(){var d=$(this).val();alarmVariables.channelSel=d});$(".J-in-full-screenen").removeClass("hide");$(".btnDel").hide();$("#xvrMotionSchedule").hide()}function listenEvents(){$(".J-in-save").on("click",function(){alarmInSave()});$(".J-out-save").on("click",function(){alarmOutSave()});$(".J-all-record-in").on("click",function(){recordAll()});$(".J-all-fullscreen-in").on("click",function(){isNVR()&&fullScreenSetAll()});$(".J-in-channel").change(function(){var a=$(this).val();if(alarmVariables.channelSel!=a){loadAlarmIn(a)}alarmVariables.channelSel=a});$(".J-out-channel").change(function(){var a=$(this).val();loadAlarmOut(a)})}function alarmInSave(){var c=getValidRecData();if(!c){rightPopup(lang.recinvalidsce);return}var f,d,a=setBit2Val("getalarminout",getConf("isNvrAlarmOutEn"))+"";if(getTotalChannelNum()<54){f=setBit2Val("alarmInRecord",getTotalChannelNum())+"";d=setBit2Val("alarmInFullScr",getTotalChannelNum())+""}else{f=set2Bit64Val("alarmInRecord",getTotalChannelNum())+"";d=set2Bit64Val("alarmInFullScr",getTotalChannelNum())+""}var b=getMatchValue("alarmIn");b.trigger.alarmOutChannelMask=a;b.trigger.recordChannelMask=f;b.trigger.fullScreenChannelMask=d;if(isXVR()){b.trigger.enableFullScreenChannel=$(".J-all-fullscreen-in").is(":checked")}else{delete b.trigger.enableFullScreenChannel}var e={channel:b.nowChannel,base:b.base,trigger:b.trigger,schedTime:getSchedTime(c)};api.alarmIn(REQUEST_SET,e,function(g,h){loading(false);rightPopup(g==0?lang.saved:lang.savedfail)})}function loadAlarmOut(a){api.alarmOut(REQUEST_GET,{channel:parseInt(a)},function(b,h){if(b!=CODE_SUCCESS){return}autoFillValue("alarmOut",h);var c=h.schedTime,f=0,l=0,d=window.g_mapCate[RECORD_TYPE_NORMAL].name,k=alarmVariables.timeSeg.find(".J-time-sel");onBtnDelAllClk();for(var e=0;e<c.length;++e){for(var g=0;g<c[e].oneDay.length;++g){f=c[e].oneDay[g].startTime/60;l=c[e].oneDay[g].endTime/60;if(f===0&&l===0){continue}k.timeSegSelect("addCateTimeData",e,d,f,l)}}})}function alarmOutSave(){var b=getValidRecData();if(!b){rightPopup(lang.recinvalidsce);return}var a=getMatchValue("alarmOut");var c={channel:a.nowChannel,base:a.base,schedTime:getSchedTime(b)};api.alarmOut(REQUEST_SET,c,function(d,e){loading(false);rightPopup(d==0?lang.saved:lang.savedfail)})}function onAlarmInputLoad(){alarmVariables.timeSeg=$(".J-time-alarm-in");initRecSetEx();loadAlarmIn(0);$(".J-in-channel").val(0)}function onAlarmOutputLoad(){alarmVariables.timeSeg.find(".J-time-sel").timeSegSelect("destroy");alarmVariables.timeSeg=$(".J-time-alarm-out");initRecSetEx();loadAlarmOut(0);$(".J-out-channel").val(0)};