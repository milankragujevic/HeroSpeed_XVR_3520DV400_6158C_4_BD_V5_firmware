var deviceManageVariables={gSearchSelNum:0,channelsel:new Array,$allDiv:null,$editDiv:null,gAddedTotal:0,netmask:"",gateway:"",gEnableChNum:0,bInstalled:false,iEnablePoeNum:0,gPtype:0,channelType:1,isGetchanuserpwd:null,channelNum:getTotalChannelNum(),distanceStatus:[],nSearchDeviceVal:[],nSearchDeviceValAdd:new SearchDeviceValAdd()};function onLoad(){initDot();bindTagHead();initDeviceManagement()}function initDeviceManagement(){initDeviceManageEvent();initPowerSetEvent();initPoeBondingEvent();setConf("isDomainEn",true)}function onDeviceManageLoad(){initDeviceManage();$("#editCancel").click()}function onPowerSetLoad(){initPowerSet()}function onPoeBondingLoad(){initPoeBonding()}function onDeviceManageBeforeunload(){}function getDeviceManageData(){}function onSave(){}function initDeviceManageEvent(){$(".J-add-device").on("click",function(){addDevice()});$(".J-manual-add").on("click",function(){manualAddDev()});$(".J-delete-device").on("click",function(){delAddedDev()});$(".J-upgrade-device").on("click",function(){selectFile()});$("#iptUpgradFile").change(function(b){var a=$(this).val();$("#ipc_updateFile").val(a);if(a.replace(/[\n]/ig,"")!=""){$("#updatefile").show();$("#updateprogress").show()}});$(".J-online-update").on("click",function(){onOlUpgradeClk()});$(".J-search-check").on("click",function(){enablesearchallvalue()});$(".J-search-checkbox").on("click",function(){enablesearchvalue($(this).val())});$(".J-search-btn").on("click",function(){addDevice($("#getprotocl").val())});$(".J-add-btn").on("click",function(){onSearchListAdd()});$(".J-cancel-btn").on("click",function(){hideDeviceDlg(true)});$(".J-addedip-check").on("click",function(){addedipcheck()});$(".J-added-domain").on("click",function(){addeddomaincheck()});$(".J-edit-ok").on("click",function(){onSaveEdit()});$(".J-update-btn").on("click",function(){deviceUpgrade()});$(".J-chlist-checkbox").on("change",function(){onAddedListChkAll()});$(".J-cpch-row").on("click",function(){$("#tabChannelList tbody tr").removeClass("select");$(this).addClass("select")});$("#cpSearchRow").click(function(){$(this).parent().children("tr").removeClass("select");$(this).addClass("select")}).dblclick(function(){if($(this).attr("added")){return}$("#searchcheck").prop("checked",false);enablesearchallvalue();$(this).find("input[id^='searchcheck']").click();onSearchListAdd()});$("#editaddedchannel").change(function(){getEditData($(this).val())});$("#editaddedprotol").change(function(){var a=$(this).val();$(".J-td-inputport").hide();$("#tdinputmainstream").hide();$("#tdinputsubstream").hide();$("#tdinputdomain").hide();if(a==PROTOCOL_TYPE_RTSP){$("#tdinputmainstream").show();$("#tdinputsubstream").show()}else{$("#tdinputip").show();$(".J-td-inputport").show();$("#tdinputdomain").show()}if(!getConf("isDomainEn")){$("#tdinputdomain").hide();$(".J-addedip-check").hide()}if(isPoeEnable()){if(a==PROTOCOL_TYPE_ONVIF||ParseInt($("#editaddedchannel").val())>=getDevConf("poeNum")){$("#selAddWay").prop("disabled",true)}else{$("#selAddWay").prop("disabled",false)}}});$("#editCancel").click(function(){$("#divTop").hide()});$("#addedName").bind("keydown keyup blur",function(){if(!isXVR()){checkStringValid($(this).val(),this,1)}else{checkStringValid($(this).val(),this,2)}})}function initPowerSetEvent(){$(".J-check-change").on("change",function(){checkChange()});$(".J-save-binding").on("click",function(){savePoeBinding()})}function initPoeBondingEvent(){$(".J-long-change").on("change",function(){longChange()});$(".J-short-change").on("change",function(){shortChange()});$(".J-save-setting").on("click",function(){savePoeSetting()})}function SearchDeviceValAdd(){this.channel=new Array;this.chanenable=new Array;this.channame=new Array;this.channo=new Array;this.chanstream=new Array;this.chanip=new Array;this.chanport=new Array;this.chanusername=new Array;this.chanpwd=new Array;this.chanprotocol=new Array;this.chanprotype=new Array;this.chanisdomain=new Array;this.chandevicedomain=new Array;this.chantype=new Array;this.getchannellinkinfoget=new Array}function selectFile(){if($("#tabChannelList input:checked").length>4){checkLimitTip()}else{for(var a=0;a<deviceManageVariables.channelNum;a++){var b="#searchCheckAdded"+a;if($(b).is(":checked")){$("#iptUpgradFile").click();return}}alert(lang.upgradeTips1)}}function onOlUpgradeClk(){if($("#tabChannelList input:checked").length===0){alert(lang.upgradeTips1);return}if($("#tabChannelList input:checked").length>4){checkLimitTip()}else{loading(true);var a=[];for(var b=0;b<deviceManageVariables.channelNum;++b){a.push($("#searchCheckAdded"+b).prop("checked")?"1":"0")}xvr.getVal(["setipconlineupgradechn="+a.join(";")+";"],function(e,f){var d=splitOkVal(f);var c=ParseInt(d.setipconlineupgradechn);switch(c){case 0:rightPopup(lang.olUpgTip2);break;case 1:xvr.getVal(["getipconlineupgradefilenmae"],function(h,i){var g=splitOkVal(i);if(!confirm(lang.dl1+":"+g.getipconlineupgradefilenmae+"\n"+lang.olUpgTip4)){return loading(false)}startOlUpgrade(a)});return;default:rightPopup(lang.olUpgTip3+c);break}loading(false)})}}function startOlUpgrade(a){xvr.getVal(["setipconlineupgradedownload"],function(b){loading(false);if(b!=HTTP_OK){rightPopup(lang.upgradeError3+-1);return}window.timerOLUpg&&clearInterval(window.timerOLUpg);window.timerOLUpg=setInterval(function(){xvr.getVal(["getipconlineupgradeprogress"],function(f,h){if(f!=HTTP_OK){return}var e=splitOkVal(h);var d=ParseInt(e.getipconlineupgradeprogress);if(d>=100){FrameShowProgess(-1);var g=[];for(var c=0;c<a.length;++c){if(a[c]=="0"){continue}g.push(lang.channel+(c+1))}g=g.join(", ");rightPopup(g+lang.olUpgTip5)}else{if(d<0){FrameShowProgess(-1);rightPopup(lang.logfiledownfail)}else{FrameShowProgess(d,lang.olUpgTip6);return}}clearInterval(window.timerOLUpg);window.timerOLUpg=null})},1000)})}function setProgress(){var a=plugin().getUpgradeProcess();if(a<=100){$("#progressText").text(a+"%");a=parseInt(a)*4.5;$("#progressInner").width(a);setTimeout("setProgress()",1000)}else{if(a==1281){$("#progressOuter").text("100%");$("#progressInner").width(450);loading(false);window.top.doRestartCount(2)}else{loading(false);rightPopup(lang.upgradeError3+a+".")}}}function deviceUpgrade(){loading(true);var a=$("#ipc_updateFile").val();if(a==""){return rightPopup(lang.upgradeError1)}if(confirm(lang.upgradeTips)==false){return}var b=new FormData($("#fmUpgrade")[0]);api.upgrade(b,function(d,c){if(c!=HTTP_OK){return}setProgress()})}function setProgress(){api.upgradeProcess(REQUEST_GET,function(a,b){var c=b.process;if(c<99){$("#progressText").text(c+"%");c=parseInt(c)*3.6;$("#progressInner").width(c);setTimeout(setProgress,1000)}else{$("#progressOuter").text("100%");$("#progressInner").width(362);loading(false);doRestartCount(1)}})}function initDeviceManage(){deviceManageVariables.netmask=getDevConf("defaultNetmask");!deviceManageVariables.netmask&&(deviceManageVariables.netmask="");deviceManageVariables.gateway=getDevConf("defaultGateway");!deviceManageVariables.gateway&&(deviceManageVariables.gateway="");deviceManageVariables.gEnableChNum=getChHDNum();setTitle(lang.optionremote);var b={ONVIF:PROTOCOL_TYPE_ONVIF,Private:PROTOCOL_TYPE_PRIVATE,RTSP:PROTOCOL_TYPE_RTSP};$("#editaddedprotol").empty();for(var d in b){$("<option></option>").val(b[d]).html(d).appendTo($("#editaddedprotol"))}setEditNumberStyle("#addedport");setIpEditStyle("addedip");$("#editaddedchannel").empty();for(var c=0,a="";c<deviceManageVariables.channelNum;++c){if(!isXVR()||vChannelConfig[c]==0){a=(c<9?"CH0":"CH")+(c+1);$("<option value='"+c+"' >"+a+"</option>").appendTo($("#editaddedchannel"))}}if(isPoeEnable()){$("#selAddWay").change(function(){var e=$(this);if(e.val()==1){$("#edit").find("input").not("[type='button']").prop("disabled",true);$("#edit").find("select").not("#selAddWay").not("#editaddedchannel").prop("disabled",true);$("#getchanenable").prop("checked",$("#edit").attr("ls-mode")!="0")}else{if(e.val()==0){$("#edit").find("input").prop("disabled",false);$("#edit").find("select").not("#selAddWay").prop("disabled",false)}}});$(".J-func-poe").removeClass("hide")}initAddedChList()}function getChHDNum(){if(!isXVR()){return deviceManageVariables.channelNum}var a=0;for(var b=0;b<deviceManageVariables.channelNum;b++){if(vChannelConfig[b]==0){++a}}return a}function hideDeviceDlg(a){if(a){$("#logTab tr").not("[id]").remove()}$("#all").hide()}function sortList(e,b,c){var d,a;c?(d=1,a=-1):(d=-1,a=1);e&&e.length&&e.sort(function(g,f){var h=compareIP(g[b],f[b]);if(g[b]&&f[b]){return(h==-1)?a:(h==0?0:d)}else{if(g[b]){return d}else{return a}}})}function addDevice(c,d){$("#logTab tbody tr").not("#cpSearchRow").remove();var f=$("#searchindex");f.html(lang.logNum);setSearchListUncheck();var b=function(n){var l=0;deviceManageVariables.nSearchDeviceVal=[];for(var k=0;k<n.length;++k){var j={};j.ip=n[k].ip;j.username=n[k].username;j.pwd=n[k].password;j.port=n[k].port;j.type=n[k].protocolType;j.manu=n[k].manu;j.mac=n[k].mac;j.devType=n[k].protocolType;j.pIndex=n[k].pIndex;j.sel=0;deviceManageVariables.nSearchDeviceVal.push(j);var h=$("#cpSearchRow").clone(true).removeClass("hide").removeAttr("id");l%2===0&&h.addClass("tableodd");var o=h.children("td");o.eq(0).children("input").attr("id","searchcheck"+k).val(k);var g=[j.ip,j.username,j.pwd,deviceManageVariables.netmask,deviceManageVariables.gateway,l];++l;o.eq(1).html(l);o.eq(2).children("a").attr("href","javascript:editip('"+g.join("','")+"');");o.eq(3).html(j.ip);if(window.addedIP.indexOf(j.ip)!==-1){h.attr("added","1");o.eq(4).html(lang.added)}o.eq(5).html(j.port);o.eq(6).html(j.devType);$("#logTab tbody").append(h)}f.html(lang.logNum+"("+deviceManageVariables.nSearchDeviceVal.length+")");var m=$("#tabSearchHeader>div.tab-td");$td=$("#logTab>tbody>tr").not("#cpSearchRow").eq(0).children("td");$td.each(function(i){var p=parseInt($(this).width());m.eq(i).width(p)});loading(false)};if(!d){$("#all").attr("style","display:block");c=c?parseInt(c):PROTOCOL_TYPE_ONVIF_PRIVATE;deviceManageVariables.gPtype=c;$("#getprotocl").val(c);var e=getUserName();var a=getAuth();api.newGetCapability(REQUEST_GET,{username:e},function(g,l){var o=roundOne();var n=l.encryptionType[0];var m=roundTwo(e,l.param[n].salt,o[0],a);var k=reverseRoundThree(m);var j=roundFour(l.param[n].iterations,k);var i=roundFive(j);var h={encryptionType:n,loginName:String(getUserName()),datetime:o[1],iv:"afe13ds34cdjk08c",protocol:getProtcolName(c)};loading(true);api.searchCamera(REQUEST_GET,h,function(p,t){var x=t.devList;var v=[];for(var u=0;u<x.length;++u){var r=false;try{x[u].username=decrypt(x[u].username,i);x[u].password=decrypt(x[u].password,i)}catch(w){}for(var s=0;s<v.length;++s){if(v[s].ip==x[u].ip&&(isNVR()||c!=PROTOCOL_TYPE_PRIVATE&&c!=PROTOCOL_TYPE_ONVIF_PRIVATE||v[s].mac==x[u].mac||!x[u].mac||!v[s].mac)){r=true;if(x[u].protocolType=="Private"){v[s].protocolType="Private"}break}}if(r){continue}v.push(x[u])}x=v;var q=true;$("#tabSearchHeader>div.tab-td[sortby]").attr("asc",q?1:0).off("click").on("click",function(){var y=!($(this).attr("asc")==1);$(this).attr("asc",y?1:0);sortList(x,$(this).attr("sortby"),y);addDevice($("#getprotocl").val(),x)});sortList(x,"ip",q);b(x)})})}else{b(d)}}function showDeviceDlg(){$("#all").attr("style","display:block")}function initAddedChList(e){$("body").prepend(dotRender("loadingModel",true));deviceManageVariables.gAddedTotal=0;var d=$("#tipAdded");setAddedListUncheck();var b=0;var c=function(h,k,j){++b;if(h==0){var g=parseInt(k.channel);k=k.channelList}$(".J-special-loading-block").remove();$("#tabChannelList tbody tr").not("#channelRow").remove();d.html(lang.channel);b=0;deviceManageVariables.iEnablePoeNum=0;window.addedIP=[];for(var g=0;g<k.length;++g){try{k[g]["username"]=k[g]["username"]?decrypt(k[g]["username"],j):k[g]["username"]}catch(n){console.log("无法解密",k.username,"<=name key=>",j)}deviceManageVariables.nSearchDeviceValAdd.channel[g]=k[g]["channel"];deviceManageVariables.nSearchDeviceValAdd.chanenable[g]=k[g]["enable"];deviceManageVariables.nSearchDeviceValAdd.channo[g]=k[g]["channel"];deviceManageVariables.nSearchDeviceValAdd.chanstream[g]=k[g]["streamNo"];deviceManageVariables.nSearchDeviceValAdd.chanip[g]=k[g]["ip"];deviceManageVariables.nSearchDeviceValAdd.chanport[g]=k[g]["port"];deviceManageVariables.nSearchDeviceValAdd.chanusername[g]=k[g]["username"];deviceManageVariables.nSearchDeviceValAdd.chanprotype[g]=k[g]["protocolType"];deviceManageVariables.nSearchDeviceValAdd.chanisdomain[g]=k[g]["domain"]?0:1;deviceManageVariables.nSearchDeviceValAdd.chandevicedomain[g]=k[g]["domain"];deviceManageVariables.nSearchDeviceValAdd.chantype[g]=k[g]["channelType"];if(getConf("isXvrLink")){deviceManageVariables.nSearchDeviceValAdd.getchannellinkinfoget[g]=isXVR()?k[g]["linkStatus"]:k[g]["getchannellinkinfoget"]}if(k[g]["enable"]!=false){++b;++deviceManageVariables.gAddedTotal;isXVR()&&$("#divChannelList .remotecfg").hide();var m=$("#channelRow").clone(true);m.removeAttr("id").removeClass("hide").addClass(b%2?"tableodd":"tableeven");var f=m.children("td");f.eq(0).children("input").attr("id","searchCheckAdded"+g).change(function(){$(this).is(":checked")||$("#searchCheckAdded").prop("checked",false)}).val(g);f.eq(1).html(g+1);f.eq(2).children("a").attr("href","javascript:editaddedip("+g+");");f.eq(3).children("a").attr("ch",g).click(function(){var p=ParseInt($(this).attr("ch"));if(isNaN(p)){return}if(deviceManageVariables.nSearchDeviceValAdd.chantype[p]==CHANNEL_TYPE_POE){rightPopup(lang.poeDelNote)}else{$(this).removeAttr("ch");delDevice(p,function(){initAddedChList()})}});f.eq(4).children("a").attr("ch",g).click(function(){var p=ParseInt($(this).attr("ch"));loadEncodeHtml(p)});var l=k[g]["ip"],i=k[g]["port"];if(k[g]["channelType"]==PROTOCOL_TYPE_RTSP){l=k[g]["rtspMainStreamUrl"]}else{l=getConf("domainEnable")&&k[g]["enableDomain"]==1?k[g]["domain"]:k[g]["ip"];i=k[g]["port"]}f.eq(5).html(l);window.addedIP.push(l);if(getConf("isXvrLink")){if(deviceManageVariables.nSearchDeviceValAdd.getchannellinkinfoget[g]==0){$("#tabChHeader>div.tab-td").eq(6).show();f.eq(6).show();f.eq(6).html(lang.disknormal)}else{$("#tabChHeader>div.tab-td").eq(6).show();f.eq(6).show();f.eq(6).html(lang.optionexception)}}else{$("#tabChHeader>div.tab-td").eq(6).hide()}f.eq(7).html(i);f.eq(8).html(k[g]["protocolType"]);$("#tabChannelList tbody").append(m)}k[g]["getchantype"]==CHANNEL_TYPE_POE&&++deviceManageVariables.iEnablePoeNum}syncSearchListAdded();d.html(lang.channel+"("+b+")");var o=$("#tabChHeader>div.tab-td");$td=$("#tabChannelList>tbody>tr").not("#channelRow").eq(0).children("td");$td.each(function(p){var q=parseInt($(this).width());o.eq(p).width(q)});e&&e()};var a=function(g){var h=getUserName();var f=getAuth();api.newGetCapability(REQUEST_GET,{username:h},function(i,m,o){var q=roundOne();var p=m.encryptionType[0];var n=roundTwo(h,m.param[p].salt,q[0],f);var l=reverseRoundThree(n);var k=roundFour(m.param[p].iterations,l);strSrcData4=roundFive(k);var j={encryptionType:p,loginName:String(h),datetime:q[1],iv:"afe13ds34cdjk08c"};api.channelList(REQUEST_GET,j,function(r,s){c(r,s,strSrcData4)})})};a(0)}function getRecordPsw(c){var b=getUserName();var a=getAuth();api.newGetCapability(REQUEST_GET,{username:b},function(d,i){var l=roundOne();var k=i.encryptionType[0];var j=roundTwo(b,i.param[k].salt,l[0],a);var h=reverseRoundThree(j);var g=roundFour(i.param[k].iterations,h);var f=roundFive(g);var m=PROTOCOL_TYPE_ONVIF_PRIVATE;var e={encryptionType:k,loginName:String(getUserName()),datetime:l[1],iv:"afe13ds34cdjk08c",protocol:getProtcolName(m)};loading(true);api.searchCamera(REQUEST_GET,e,function(q,r){loading(false);var p=r.devList;for(var o=0;o<p.length;++o){try{p[o].password=decrypt(p[o].password,f)}catch(n){}o<deviceManageVariables.channelNum&&(deviceManageVariables.nSearchDeviceValAdd.chanpwd[o]=p[o].password)}c&&c()})})}function syncSearchListAdded(){var b=$("#cpSearchRow").next();while(b.length>0){var a=b.children().eq(3).html();if(window.addedIP.indexOf(a)!==-1){b.attr("added","1");b.children().eq(4).html(lang.added)}b=b.next()}}function loadEncodeHtml(a){m_nEncodeSelChannel=a;$("#recordTitle a").click();setTimeout(function(){$("[name=encode]").click()},100)}function manualAddDev(){for(var a=0;a<deviceManageVariables.channelNum;++a){if(deviceManageVariables.nSearchDeviceValAdd.chanenable[a]==false&&(!isXVR()||vChannelConfig[a]==0)){editaddedip(a);return}}}function editaddedip(a){$("#edit input[type='text']").val("");$("#edit input[type='password']").val("");$("#edit input[type='checkbox']").prop("checked",false);$("#divTop").show();$("#editaddedchannel").val(a).change()}function addedipcheck(){if($(".J-addedip-check").is(":checked")){$("#addeddomain").prop("disabled",true);$("#addedip").prop("disabled",false);$(".J-added-domain").prop("checked",false)}else{$("#addeddomain").prop("disabled",false);$("#addedip").prop("disabled",true);$(".J-added-domain").prop("checked",true)}}function addeddomaincheck(){if($(".J-added-domain").is(":checked")){$("#addeddomain").prop("disabled",false);$("#addedip").prop("disabled",true);$(".J-addedip-check").prop("checked",false)}else{$("#addeddomain").prop("disabled",true);$("#addedip").prop("disabled",false);$(".J-addedip-check").prop("checked",true)}}function getEditData(b){b=parseInt(b);var c=getUserName();var a=getAuth();api.newGetCapability(REQUEST_GET,{username:c},function(d,i,k){var m=roundOne();var l=i.encryptionType[0];var j=roundTwo(c,i.param[l].salt,m[0],a);var h=reverseRoundThree(j);var g=roundFour(i.param[l].iterations,h);var e=roundFive(g);var f={encryptionType:l,loginName:String(c),datetime:m[1],iv:"afe13ds34cdjk08c",channel:parseInt(b)};api.channelEdit(REQUEST_GET,f,function(q,r){try{r.username=r.username?decrypt(r.username,e):r.username}catch(o){console.log("无法解密",r.username,"<=name key=>",e)}autoFillValue("channelEdit",r);$("#selAddWay").val(r.channelType);if(q!=CODE_SUCCESS){return}var n=r.password;deviceManageVariables.isGetchanuserpwd=encodePwd(n);if(isXVR()){r.streamNo=CHANNEL_STREAM_SUB;$("#editaddedstream").val(r.streamNo).prop("disabled",true)}else{$("#editaddedstream").prop("disabled",false);$("#editaddedstream").parent().parent().hide()}var s=r.protocolType;$("#editaddedprotol option:contains("+s+")").attr("selected","selected");$("#editaddedprotol").val()===null&&$("#editaddedprotol option:contains("+s+")").attr("selected","selected");$(".J-td-inputport").hide();$("#tdinputmainstream").hide();$("#tdinputsubstream").hide();$("#tdinputdomain").hide();if(s=="ONVIF"){$("#tdinputip").show();$(".J-td-inputport").show();$("#tdinputdomain").show()}else{if(s=="RTSP"){$("#tdinputmainstream").show();$("#tdinputsubstream").show()}else{if(s=="Private"){$("#tdinputip").show();$(".J-td-inputport").show();$("#tdinputdomain").show()}else{$("#tdinputip").show();$(".J-td-inputport").show();$("#tdinputdomain").show()}}}if(!getConf("isDomainEn")){$("#tdinputdomain").hide();$(".J-addedip-check").hide()}else{var p=r.enableDomain;if(!p){$("#addeddomain").prop("disabled",true);$("#addedip").prop("disabled",false);$(".J-addedip-check").prop("checked",true)}else{$("#addeddomain").prop("disabled",false);$("#addedip").prop("disabled",true);$(".J-addedip-check").prop("checked",false)}}if(isPoeEnable()){if(b>=getDevConf("poeNum")){$("#selAddWay").prop("disabled",true).val(0)}else{$("#selAddWay").prop("disabled",false)}$("#edit").attr("ls-mode",r.enable);$("#selAddWay").change()}deviceManageVariables.channelType=r.channelType})})}function onSaveEdit(){var b=getMatchValue("channelEdit");b.channel=parseInt($("#editaddedchannel").val());b.streamNo=1;if(b.protocolType===2){b.protocolType="ONVIF"}else{if(b.protocolType===3){b.protocolType="RTSP"}else{if(b.protocolType===4){b.protocolType="Private"}}}!isPoeEnable()&&delete b.channelType;if(!checkUserPwdValid($("#addedpwd").val())){rightPopup(lang.nosupport);return}var a=$("#editaddedprotol").val();if(a!=PROTOCOL_TYPE_RTSP&&$(".J-addedip-check").is(":checked")&&$("#addedip").val()=="0.0.0.0"){rightPopup(lang.IPAddr+lang.formatErr);return}if(!checkDomain($("#addeddomain").val())){if((a==PROTOCOL_TYPE_ONVIF||a==PROTOCOL_TYPE_PRIVATE)&&$(".J-added-domain").is(":checked")){rightPopup(lang.domain+lang.formatErr);return}else{$("#addeddomain").val("")}}if(a==PROTOCOL_TYPE_ONVIF||a==PROTOCOL_TYPE_PRIVATE){if($("#addedport").val()>65535){rightPopup(lang.port+lang.fanwei+"<65535");return}}var c=getUserName();api.newGetCapability(REQUEST_GET,{username:c},function(d,h,j){var m=getAuth();var k=h.encryptionType[0];var l=roundOne();var i=roundTwo(c,h.param[k].salt,l[0],m);var g=reverseRoundThree(i);var f=roundFour(h.param[k].iterations,g);var e=roundFive(f);b.password=(deviceManageVariables.isGetchanuserpwd==$("#addedpwd").val())?encrypt(deviceManageVariables.isGetchanuserpwd,e):encrypt($("#addedpwd").val(),e);b.encryptionType=k;b.loginName=String(c);b.datetime=l[1];b.iv="afe13ds34cdjk08c";b.username=encrypt(b.username,e);loading(true);api.channelEdit(REQUEST_SET,b,function(o,n){rightPopup(o==CODE_SUCCESS?lang.saved:lang.savedfail);if(o!=CODE_SUCCESS){return}loading(false);$("#editCancel").click();initAddedChList()})})}function onAddedListChkAll(){$("#tabChannelList tbody tr:not(#channelRow) td:first-child input").prop("checked",$("#searchCheckAdded").prop("checked"))}function delAddedDev(){var d=0,a=function(i,j){if(d<b.length-1){++d;delDevice(b[d],a)}else{loading(false);initAddedChList()}},b=[],f=false;var h=$("#tabChannelList tbody tr:not(#channelRow) td:first-child input");for(var c=0;c<h.length;++c){var g=h.eq(c);var e=parseInt(g.val());if(g.prop("checked")&&deviceManageVariables.nSearchDeviceValAdd.chantype[e]==CHANNEL_TYPE_POE){f=true;break}if(g.prop("checked")){b.push(e)}}if(f){rightPopup(lang.poeDelNote)}else{delDevice(b[d],a)}}function delDevice(a,c){var b=getUserName();api.newGetCapability(REQUEST_GET,{username:b},function(d,i,k){var n=getAuth();var l=i.encryptionType[0];var m=roundOne();var j=roundTwo(b,i.param[l].salt,m[0],n);var h=reverseRoundThree(j);var g=roundFour(i.param[l].iterations,h);var e=roundFive(g);var f={encryptionType:l,loginName:String(b),datetime:m[1],iv:"afe13ds34cdjk08c",channel:a,streamNo:1,enable:false,protocolType:String(deviceManageVariables.nSearchDeviceValAdd.chanprotype[a]),username:deviceManageVariables.nSearchDeviceValAdd.chanusername[a]?encrypt(deviceManageVariables.nSearchDeviceValAdd.chanusername[a],e):"",ip:String(deviceManageVariables.nSearchDeviceValAdd.chanip[a]),port:parseInt(deviceManageVariables.nSearchDeviceValAdd.chanport[a]),enableDomain:false,domain:null,channelType:0};api.channelEdit(REQUEST_SET,f,function(o,p){if(o!=CODE_SUCCESS){return}c&&c()})})}function enablesearchallvalue(){var a=$("#searchcheck").is(":checked");$("#logTab tbody tr").not("#cpSearchRow").find("td:first-child>input[type='checkbox']").prop("checked",a);var c=a?1:0;for(var b=0;b<deviceManageVariables.nSearchDeviceVal.length;++b){deviceManageVariables.nSearchDeviceVal[b].sel=c}}function enablesearchvalue(b){var a=$("#searchcheck"+b).prop("checked");deviceManageVariables.nSearchDeviceVal[b].sel=a?1:0;a||$("#searchcheck").prop("checked",false)}function onSearchListAdd(){if(deviceManageVariables.gEnableChNum>0){for(var a=0;a<deviceManageVariables.nSearchDeviceVal.length;++a){if(window.addedIP.indexOf(deviceManageVariables.nSearchDeviceVal[a].ip)!==-1){deviceManageVariables.nSearchDeviceVal[a].sel=0;continue}deviceManageVariables.nSearchDeviceVal[a].sel==1&&++deviceManageVariables.gSearchSelNum}if(deviceManageVariables.gSearchSelNum>0){isXVR()?selchannel():addSearchDev()}}}function setAddedListUncheck(){$("#tabChannelList td:first-child input[type='checkbox']").prop("checked",false);$("#searchCheckAdded").prop("checked",false)}function setSearchListUncheck(){$("#searchcheck").prop("checked",false);$("#logTab td:first-child input[type='checkbox']").prop("checked",false);for(var a=0;a<deviceManageVariables.nSearchDeviceVal.length;++a){deviceManageVariables.nSearchDeviceVal[a].sel=0}deviceManageVariables.gSearchSelNum=0}function addSearchDev(){var f=deviceManageVariables.gAddedTotal,b=0;var g=[];for(var a=0,d=0;f<deviceManageVariables.gEnableChNum&&a<deviceManageVariables.nSearchDeviceVal.length;++a){if(deviceManageVariables.nSearchDeviceVal[a].sel==1){while(d<deviceManageVariables.channelNum){if((!isXVR()||vChannelConfig[d]==0&&deviceManageVariables.channelsel[d]==1)&&deviceManageVariables.nSearchDeviceValAdd.chanenable[d]==false&&(!isNVR()||deviceManageVariables.nSearchDeviceValAdd.chantype[d]!=CHANNEL_TYPE_POE)){f-deviceManageVariables.gAddedTotal===1&&loading(true);++f;g.push({i:a,ch:d});++d;break}else{++d}}}}var e=0;var c=function(h,j){var k=getUserName();api.newGetCapability(REQUEST_GET,{username:k},function(i,p,r){var u=getAuth();var s=p.encryptionType[0];var t=roundOne();var q=roundTwo(k,p.param[s].salt,t[0],u);var o=reverseRoundThree(q);var n=roundFour(p.param[s].iterations,o);var l=roundFive(n);var m={encryptionType:s,loginName:String(k),datetime:t[1],iv:"afe13ds34cdjk08c",channel:j,streamNo:1,enable:true,protocolType:String(deviceManageVariables.nSearchDeviceVal[h].devType),username:encrypt(deviceManageVariables.nSearchDeviceVal[h].username,l),password:encrypt(deviceManageVariables.nSearchDeviceVal[h].pwd,l),ip:String(deviceManageVariables.nSearchDeviceVal[h].ip),port:parseInt(deviceManageVariables.nSearchDeviceVal[h].port),enableDomain:false,domain:null,channelType:0};api.channelEdit(REQUEST_SET,m,function(v,w){if(v!=CODE_SUCCESS){return}++b;if(b>=f-deviceManageVariables.gAddedTotal){loading(false);initAddedChList();setSearchListUncheck()}e++;if(e<g.length){c(g[e].i,g[e].ch)}})})};g[0]&&c(g[0].i,g[0].ch)}function editip(f,b,e,a,d,c){hideDeviceDlg();deviceManageVariables.$allDiv=$('<div id="all"></div>').css("opacity",1);deviceManageVariables.$editDiv=$('<div id="edit">        <div class="edit-header"></div>        <div class="edit-content form-item">            <div ><span class="width200"><label>'+lang.IPAddress+'</label></span><span ><input maxlength="31" class="small-input" id="ip" name="ip" type="text"  value="'+f+'"  /></span></div>            <div class="clear" > </div>            <div ><span class="width200"><label>'+lang.cameraMask+'</label></span><span ><input maxlength="31" class="small-input" id="mask" name="mask" type="text"  value="'+a+'"  /></span></div>            <div class="clear" > </div>            <div ><span class="width200"><label>'+lang.st4Gateway+'</label></span><span ><input maxlength="31" class="small-input" id="gateway" name="gateway" type="text"  value="'+d+'"  /></div>            <div class="clear" > </div>            <div ><span class="width200"><label>'+lang.userName+'</label></span><span ><input maxlength="31" class="small-input" id="name" name="name" type="text"  value="'+b+'"  /></div>            <div class="clear" > </div>            <div ><span class="width200"><label>'+lang.pwd+'</label></span><span ><input maxlength="31" class="small-input" id="pwd" name="pwd" type="password"  value=""  /></div>            <div class="clear" > </div>            <div class="form-item">        <span><input type="button" class="btn browser-btn" id="usereditOK" onclick="postSearchEdit(\''+c+'\');" value ="'+lang.confirm+'" style="display: block;"/></span>    <span><input type="button" class="btn browser-btn" id="editCancel"  value ="'+lang.cancel+'" /></span>    </div>            </div>        </div>    </div>');$("body").prepend(deviceManageVariables.$allDiv).prepend(deviceManageVariables.$editDiv);$("#editCancel").click(function(){deviceManageVariables.$allDiv.remove();deviceManageVariables.$editDiv.remove();showDeviceDlg()});setIpEditStyle("ip");setIpEditStyle("mask");setIpEditStyle("gateway");$("#name").bind("keydown keyup blur",function(){if(!isXVR()){checkStringValid($(this).val(),this,1)}else{checkStringValid($(this).val(),this,2)}})}function postSearchEdit(b){var a=/^(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/;if((!a.test($("#ip").val()))||$("#ip").val()=="0.0.0.0"||$("#ip").val()=="255.255.255.255"){rightPopup(lang.IPAddr+lang.formatErr);return}if(!checkUserPwdValid($("#pwd").val())){rightPopup(lang.nosupport);return}xvr.setDevice(deviceManageVariables.nSearchDeviceVal[b].ip,$("#ip").val(),deviceManageVariables.netmask,deviceManageVariables.nSearchDeviceVal[b].port,$("#name").val(),$("#pwd").val(),deviceManageVariables.nSearchDeviceVal[b].mac,deviceManageVariables.nSearchDeviceVal[b].pIndex,getProtcolType(deviceManageVariables.nSearchDeviceVal[b].devType),function(c,d){if(c!=HTTP_OK){return}rightPopup(lang.saved)});deviceManageVariables.$allDiv.remove();deviceManageVariables.$editDiv.remove();addDevice(deviceManageVariables.gPtype)}function selchannel(){hideDeviceDlg();deviceManageVariables.$allDiv=$('<div id="all"></div>').css("opacity",0.9);deviceManageVariables.$editDiv=$('<div id="edit">            <div class="edit-header">'+lang.channelsel+'</div>            <div class="clear" > </div>            <div class="edit-content form-item">                <div id="RemoteEnable">                </div>    <div style="padding-top: 10px;margin-left: 25px;">            <span ><input type="button" class="btn browser-btn" id="usereditOK" onclick="remoteChannelNo();" value ="'+lang.confirm+'"/></span>        <span ><input type="button" class="btn browser-btn" id="editCancel" value ="'+lang.cancel+'" /></span>    </div>    </div>            </div>        </div>');deviceManageVariables.$editDiv.css("width","400px").css("height","400px");$("body").prepend(deviceManageVariables.$allDiv).prepend(deviceManageVariables.$editDiv);$("#editCancel").click(function(){deviceManageVariables.$allDiv.remove();deviceManageVariables.$editDiv.remove();showDeviceDlg();deviceManageVariables.gSearchSelNum=0});$("#RemoteEnable").html("");$('<div class="form-item"><span ><input id="Remoteselectall" type="checkbox" value=""/></span><span>'+lang.Autosel+"</span></div>").appendTo($("#RemoteEnable"));for(var d=0;d<deviceManageVariables.channelNum;d++){if(d%16==0){$('<div class="form-item divH" style="margin-right: 25px;width: 100%;height: 25px; line-height: 25px;"></div>').appendTo($("#RemoteEnable"))}$('<div style="width: 33.3%;height: 25px;line-height: 25px;float: left;"><span ><input id="ch'+d+'" name="box" type="checkbox"/></span><span ><label id="name'+d+(d<9?'">CH0':'">CH')+(d+1)+"</label></span></div>").appendTo($("#RemoteEnable").children("div").eq(parseInt(d/16)+1))}var a=Math.ceil($(".divH > div").length/3+1)*25;$("#RemoteEnable").css("height",a+"px");$("#RemoteEnable input[name='box']").change(function(){if($("#RemoteEnable input[name='box']").filter(":checked").length>deviceManageVariables.gSearchSelNum){$(this).prop("checked",false)}});for(var d=0;d<deviceManageVariables.channelNum;d++){if(vChannelConfig[d]!=0){var b="#ch"+d;var c="#name"+d;$(b).attr("disabled","disabled");$(c).attr("style","text-decoration:line-through")}}$("#Remoteselectall").click(function(){if($("#Remoteselectall").is(":checked")){for(var g=0,f=0;g<deviceManageVariables.channelNum;g++){var e="#ch"+g;if(deviceManageVariables.nSearchDeviceValAdd.chanenable[g]==false&&vChannelConfig[g]==0&&f<deviceManageVariables.gSearchSelNum){$(e).prop("checked",true);f++}else{$(e).prop("checked",false)}}}else{for(var g=0;g<deviceManageVariables.channelNum;g++){var e="#ch"+g;if(vChannelConfig[g]==0){$(e).prop("checked",false)}}}})}function remoteChannelNo(){var e=0,g=[],d=function(){addSearchDev();deviceManageVariables.$allDiv.remove();deviceManageVariables.$editDiv.remove();showDeviceDlg()};for(var c=0;c<deviceManageVariables.channelNum;++c){var b="#ch"+c;if($(b).is(":checked")){deviceManageVariables.channelsel[c]=1;if(deviceManageVariables.nSearchDeviceValAdd.chanenable[c]==true){++e}}else{deviceManageVariables.channelsel[c]=0}}var a=0;var f=function(h){delDevice(h,function(i,j){if(a<g.length){a++;f(g[a])}else{initAddedChList(d)}})};g.length!=0&&f(g[0]);e===0&&d()}function getProtcolName(a){a=parseInt(a);switch(a){case PROTOCOL_TYPE_ONVIF:return"ONVIF";case PROTOCOL_TYPE_RTSP:return"RTSP";case PROTOCOL_TYPE_PRIVATE:return"Private";default:return"Private-ONVIF"}}function getProtcolType(a){a=$.trim(a.toLowerCase());switch(a){case"onvif":return PROTOCOL_TYPE_ONVIF;case"rtsp":return PROTOCOL_TYPE_RTSP;case"private":return PROTOCOL_TYPE_PRIVATE;default:return PROTOCOL_TYPE_ONVIF}}function getEncodeUrl(a){a=Base64.encode(a);a.slice(-2)=="=="&&(a=a.substr(0,a.length-2)+"!!");a.slice(-1)=="="&&(a=a.substr(0,a.length-1)+"!");return a}function compareIP(e,b){var d;var c;d=e.split(".");c=b.split(".");for(var a=0;a<4;a++){if(parseInt(d[a])>parseInt(c[a])){return 1}else{if(parseInt(d[a])<parseInt(c[a])){return -1}}}return 0}function checkLimitTip(){return rightPopup(lang.chLimit)}function initPoeBonding(){var c=parseInt(getDevConf("poeNum"));loading(true);var b="";var a=function(d){api.channelPoe(REQUEST_GET,{channel:parseInt(d)},function(e,f){if(e!=CODE_SUCCESS){return}deviceManageVariables.distanceStatus[d]=f.distanceStatus;b+='<tr class="J-poe-list-item list-div">                        <td><div><input type="checkbox" '+(f.enablePoeBind?"checked":"")+"></div></td>                        <td><div>IPCamera "+(d+1)+"</div></td>                        </tr>";d++;if(d<c){a(d)}else{$(".J-poe-list").html("").append(b)}})};a(0)}function checkChange(){$(".J-poe-list-item input").prop("checked",$(".checkEnable").prop("checked"))}function savePoeBinding(){var a=0;var b=function(){var c={channel:a,distanceStatus:deviceManageVariables.distanceStatus[a],enablePoeBind:$(".J-poe-list-item input").eq(a).prop("checked")};api.channelPoe(REQUEST_SET,c,function(d,e){a++;a<parseInt(getDevConf("poeNum"))?b():showSaveMsg(d)})};b()}function initPowerSet(){var g=parseInt(getDevConf("poeNum"));loading(true);var e=0,d=0,b=new Array(g),f=0;var c="";var a=function(h){e++;api.channelPoe(REQUEST_GET,{channel:parseInt(h)},function(n,o){if(n!=CODE_SUCCESS){return}++d;d>=g?$(".idx"+d).removeClass("listDataLine"):"";b[h]={};b[h]["linkStatus"]=o.linkStatus;b[h]["power"]=o.power;b[h]["distanceStatus"]=o.distanceStatus;var i="";if(o.linkStatus){var l=Number(o.power);f+=$.isNumeric(l)?l:0;i=lang.connection}else{i=lang.unconnected}if(d>=e){c+="<tr><td>"+(h+1)+'</td>                            <td><div><input type="checkbox" name="longcheck" idx="'+h+'" /></div></td>                            <td><div><input type="checkbox" name="shortcheck" idx="'+h+'" /></div></td>                            <td><div class="poeStatus'+(h+1)+'">'+i+"</div></td>                            <td>"+b[h]["power"].toFixed(1)+"w</td>                        </tr>"}if(h<(g-1)){++h;a(h)}else{$(".J-poe-power-list").html("");$(".J-poe-power-list").append(c);for(var k=0;k<b.length;k++){if(parseInt(b[k]["distanceStatus"])){$('input[name="shortcheck"]').eq(k).prop("checked",true)}else{$('input[name="longcheck"]').eq(k).prop("checked",true)}}$('input[name="longcheck"]').click(function(){var j=$(this).attr("idx");$(".J-long-change").prop("checked",$('input[name="longcheck"]').not(":checked").length===0);$('input[name="shortcheck"]').eq(j).prop("checked",!$(this).prop("checked"))});$('input[name="shortcheck"]').click(function(){var j=$(this).attr("idx");$(".J-short-change").prop("checked",$('input[name="shortcheck"]').not(":checked").length===0);$('input[name="longcheck"]').eq(j).prop("checked",!$(this).prop("checked"))});var m={maxPower:getPoEMaxPower(parseInt(getDevConf("poeNum"))),lowerPower:0,upperPower:"30.0"};f=parseFloat(f).toFixed(2);m.actualPower=f;m.remainPower=parseFloat(m.maxPower-f).toFixed(2);$(".J-sub-prg").width(intLimit(f/m.maxPower*100,0,100)+"%");initLangPrm(m);if(!o.supportChangeDistance){$("input[type=checkbox]").prop("disabled",true)}}})};a(0)}function getPoEMaxPower(a){a=parseInt(a);switch(a){case 8:return"100.0";case 16:return"200.0";default:return"45.0"}}function longChange(){$('input[name="longcheck"]').prop("checked",$(".J-long-change").prop("checked"));$('input[name="shortcheck"]').prop("checked",!$(".J-long-change").prop("checked"));$(".J-short-change").prop("checked",!$(".J-long-change").prop("checked"))}function shortChange(){$('input[name="shortcheck"]').prop("checked",$(".J-short-change").prop("checked"));$('input[name="longcheck"]').prop("checked",!$(".J-short-change").prop("checked"));$(".J-long-change").prop("checked",!$(".J-short-change").prop("checked"))}function savePoeSetting(){for(var a=0;a<parseInt(getDevConf("poeNum"));a++){var b={channel:a,distanceStatus:$('input[name="longcheck"]').eq(a).prop("checked")?0:1};api.channelPoe(REQUEST_SET,b,function(c,d){showSaveMsg(c)})}}function replaceLangPrm(b,a){return b.replace(/(\\*{\$\w+})/g,function(d){var e=d.indexOf("\\");if(e!==-1&&(d.lastIndexOf("\\")-e)%2===0){return d}else{e=d.indexOf("$");var c=d.substring(e+1,d.length-1);return d.substring(0,e-1)+a[c]}})}function initLangPrm(a){var b=window.lang;b||(b=window.top.lang);$(".J-lang-prm").each(function(){var d=$(this);var c=d.attr("lang");d.html(replaceLangPrm(b[c],a))})};