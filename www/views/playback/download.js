$(commonInit(initDownload));m_TcpPort=5000;m_RstpPort=554;var m_nDlPos=0;var m_nDlTime="";var m_nNowDown=0;var m_strTableFileName=new Array();var m_nShowFileNumber=0;var m_nAllFileNumber=0;var m_nAllPage=0;var m_nShowPage=1;var m_nGoOutNum=20;var m_DownLoadPlugin=null;var m_nDownloadFileIndex=-1;var m_objectParent={};var m_nCalendarDate="";var m_strStartTimeSet=new Array();var m_strEndTimeSet=new Array();var m_strFileNameSet=new Array();var m_strFileSizeSet=new Array();var m_strFileTypeSet=new Array();var m_fileIndex=new Array();var channelNum=0;var m_bDownload=false;var oldCalendarDate="";var m_arrSearchMonthArray=[];var versionconfig={};var gRecSubffix="";var g_isBsCal="";var g_mapMonthRec=new Array(64);var timeZooe=new Date().getTimezoneOffset()*60*1000,currentFileList=[],currentFileIndex=0;function initDownload(){initDot();setTitle(lang.dl13);window.api=new api();initCalendarLang(getLang());setConf("isHidePlugin",true);var a=counter(1,function(){$("#videoBlock").isPlayer({isHidePlugin:true});$("#SearchChannelSlt,#SearchFTypeSlt").change(function(){onSearchRecClk()});g_isBsCal=getLang()==="bs";setEditNumberStyle("#dlgTime .blkTime input",false,onTimeEdtChg);initShowDlg();$(window).bind("beforeunload",function(){var c=$("#SearchChannelSlt").val(),b=$("#videoBlock");c&&b.isPlayer("downloadRecordFileStop",c,m_nDownloadFileIndex)});loadTime(function(b,c){$("#videoBlock").isPlayer("setDevTimeInfo",b,c)})});getDeviceInfo(a);$("#openFile").on("click",function(){$("#videoBlock").isPlayer("openDownloadFloder")})}function getDeviceInfo(a){api.getDeviceConf(REQUEST_GET,function(b,c){if(b!=CODE_SUCCESS){return}api.getDefaultParame(REQUEST_GET,function(e,d){if(e!=CODE_SUCCESS){return}var f=$.extend(c,d);initDevConf(f);setDevConf("deviceType",getDeviceType(c.devType));port=getDevConf("httpPort");a&&a();if(isXVR()){$("#SearchFTypeSlt option").each(function(g){$(this).attr("num",XVR_VIDEO_TYPE_LIST[g])})}})})}function onUnload(){setConf("isHidePlugin")}function getChMonthRec(c,b,a){c=ParseInt(c);b=ParseInt(b);return g_mapMonthRec[c]!==undefined&&g_mapMonthRec[c][b]!==undefined?g_mapMonthRec[c][b][$("#div1").commCal("getYearMonthStr",a)]:undefined}function saveChMonthRec(c,b,a,d){c=ParseInt(c);b=ParseInt(b);g_mapMonthRec[c]===undefined&&(g_mapMonthRec[c]=new Array());g_mapMonthRec[c][b]===undefined&&(g_mapMonthRec[c][b]=new Array());g_mapMonthRec[c][b][$("#div1").commCal("getYearMonthStr",a)]=d}function initDlChList(a){for(var b=0;b<a;b++){if(m_objectParent.nFileBackupDatabit[b]){$("<option value='"+b+"' id='ch_"+(b+1)+"'>"+(b+1)+"</option>").appendTo($("#SearchChannelSlt"))}}}function onDownCalMonthYearChg(b){if(!chkDownloading()){return}var d=$("#SearchChannelSlt").val(),c=$("#videoBlock");if($.isNumeric(d)){var a=getChMonthRec(ParseInt(d),$("#SearchFTypeSlt").val(),b);if(a&&a.length>0){if(g_lastSearchDate>b){b=a[a.length-1]}else{b=a[0]}}$("#div1").commCal("setSelDate",b);onSearchRecClk(true)}}function initShowDlg(){var a=window.opener.dlPagePrm;for(var d in a){m_objectParent[d]=a[d]}window.nMaxDate=new Date(m_objectParent.nDeviceYear,m_objectParent.nDeviceMonth-1,m_objectParent.nDeviceDay);window.ip=m_objectParent.ip;window.tcpport=m_objectParent.tcpport;window.loginUser=m_objectParent.loginUser;window.loginpsw=m_objectParent.loginpsw;m_TcpPort=m_objectParent.tcpport;m_RstpPort=m_objectParent.rstpport;versionconfig=m_objectParent.versionconfig;channelNum=m_objectParent.channelNum;if(!m_objectParent.isSmt){$("#SearchFTypeSlt option.optSmt").remove()}else{$("#SearchFTypeSlt option.optNvrSmt").html(lang.motionDetecting);if(!m_objectParent.isNvrAlarmInEn){toggleOption($("#SearchFTypeSlt option.optSmt").eq(0),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(1),"hide")}else{m_objectParent.isXvrNoMotionAlarmType?toggleOption($("#SearchFTypeSlt option.optSmt").eq(1),"hide"):toggleOption($("#SearchFTypeSlt option.optSmt").eq(1),"show")}if(m_objectParent.isXvrSearchType){toggleOption($("#SearchFTypeSlt option.optSmt").eq(3),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(4),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(5),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(6),"hide")}if(m_objectParent.m_devicetype!=="XVR"){toggleOption($("#SearchFTypeSlt option.optSmt").eq(8),"hide")}if(!m_objectParent.isXVRSmtCmp){toggleOption($("#SearchFTypeSlt option.optSmt").eq(7),"hide")}}if(m_objectParent.isCPUMC6630||isXVR()||isWifiNvr()){toggleOption($("#SearchFTypeSlt option.optSmt").eq(2),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(3),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(4),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(5),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(6),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(7),"hide");toggleOption($("#SearchFTypeSlt option.optSmt").eq(8),"hide")}$("#div1").commCal({minDate:new Date(2000,0,1),maxDate:window.nMaxDate,bUsePdCal:g_isBsCal,dateSel:m_objectParent.dayRec[2],onChangeMonthYear:onDownCalMonthYearChg,hightlightMax:getRecDayLimit()[m_objectParent.m_nDeviceTypeDay]});window.top.m_devicetype=a.m_devicetype;setConf("deviceType",a.m_devicetype);initDlChList(channelNum);var c=$("#videoBlock"),b=0;if(m_objectParent.m_devicetype=="XVR"){if(m_objectParent.m_bDVR){b=2}else{b=1}}else{b=0}c.isPlayer("initVideoWindow",b).isPlayer("setDeviceChannelNum",channelNum);$("#SearchChannelSlt").val(m_objectParent.m_SelChannel);if(isIE()){$("#SearchFTypeSlt").val(m_objectParent.dayRec[1])}else{var b=$("#SearchFTypeSlt option[num = "+m_objectParent.dayRec[1]+"]").val();$("#SearchFTypeSlt").val(b)}$("#div1").commCal("hlDates",m_objectParent.monthRec);saveChMonthRec(m_objectParent.m_SelChannel,m_objectParent.dayRec[1],m_objectParent.dayRec[2],m_objectParent.monthRec);onSearchRecClk()}function chkDownloading(){if(m_bDownload){$("#div1").commCal("setSelDate",g_lastSearchDate);$("#SearchFTypeSlt").val(g_lastSearchType);$("#SearchChannelSlt").val(g_lastSearchCh);rightPopup(lang.downloading);return false}return true}function onSearchRecClk(l){var a=$("#SearchChannelSlt").val();var h=$("#div1");var d=h.commCal("getSelDate");var i=ParseInt($("#SearchFTypeSlt").val());var e=getChMonthRec(a,i,d);g_lastSearchDate=d;g_lastSearchType=i;g_lastSearchCh=a;clrDlList();$(".searchtime").addClass("noclick");if(isIE()){if(e===undefined){searchMonthRec(a,i,d,function(m){h.commCal("hlDates",m);if(m.length>0){if(l){d=m[m.length-1];h.commCal("setSelDate",d)}searchDayRec(a,i,d)}else{rightPopup(lang.pb8)}})}else{h.commCal("hlDates",e).commCal("refresh");searchDayRec(a,i,d)}}else{var k=parseInt($(".ui-datepicker-year  option:selected").val()),g=parseInt($(".ui-datepicker-month  option:selected").val());var b=(getMonthBeginEnd(k,g).begin-timeZooe)/1000;var f=(getMonthBeginEnd(k,g).end-timeZooe)/1000;var i=parseInt($("#SearchFTypeSlt option:selected").attr("num"));var c={channel:parseInt(a),streamNo:0,fileType:i,startTime:String(b),endTime:String(f)};api.queryDays(REQUEST_GET,c,function(m,n){if(m!=CODE_SUCCESS){return}if(n===""){return}var o=getArrRec(n.days);$("#div1").commCal("hlDates",o);getHttpDownData(d,$("#SearchFTypeSlt option:selected").attr("num"),g_lastSearchCh,1);setTimeout(function(){if(getLocalServerWebsocketStatus()){alert(lang.noSupport14)}},2000)})}}function getHttpDownData(b,d,e,f){$("#FileTable tr:gt(0)").remove();var c=(b.getTime()-timeZooe)/1000,a=c+86399;api.getRecordInfo(REQUEST_GET,{channel:parseInt(e),streamNo:0,fileType:parseInt(d),pageIndex:0,pageItems:4000,startTime:String(c),endTime:String(a)},function(k,m){if(k!=CODE_SUCCESS){return}var l=m.itemList;if(l.length>0){for(var h=0;h<l.length;h++){for(var g in l[h]){switch(g){case"startTime":l[h][g]=new Date(l[h].startTime*1000+timeZooe).Format("yyyy-MM-dd hh:mm:ss");break;case"endTime":l[h][g]=new Date(l[h].endTime*1000+timeZooe).Format("yyyy-MM-dd hh:mm:ss");break}}m_strStartTimeSet.push(l[h].startTime);m_strEndTimeSet.push(l[h].endTime);m_strFileNameSet.push(l[h].fileName);m_strFileSizeSet.push(l[h].fileSize);m_strFileTypeSet.push(l[h].fileType);m_fileIndex.push(l[h].idx===undefined?h:l[h].idx)}}else{rightPopup(lang.pb8)}refreshDlList()})}function clrDlList(){m_strStartTimeSet=[];m_strEndTimeSet=[];m_strFileNameSet=[];m_strFileSizeSet=[];m_strFileTypeSet=[];m_fileIndex=[];currentFileList=[];refreshDlList()}function searchDayRec(ch,type,date){var year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();var conv=function(jsonFileInfo){var arrRec=eval("["+jsonFileInfo+"]");if(!arrRec||arrRec.length===0){rightPopup(lang.pb8)}else{clrDlList();for(var i=0;i<arrRec.length;i++){var arrRecStartDay=arrRec[i].ulStartTime.split(" ")[0].split("-")[2];var arrRecStopDay=arrRec[i].ulStopTime.split(" ")[0].split("-")[2];if(day!=arrRecStartDay&&day!=arrRecStopDay){continue}m_strStartTimeSet.push(arrRec[i].ulStartTime);m_strEndTimeSet.push(arrRec[i].ulStopTime);m_strFileNameSet.push(arrRec[i].ucFileName);m_strFileSizeSet.push(arrRec[i].ulFileLen);m_fileIndex.push(arrRec[i].fileIndex===undefined?i:arrRec[i].fileIndex)}var bt=new Date(m_strStartTimeSet[0].replace(/-/g,"/")),et=new Date(m_strEndTimeSet[0].replace(/-/g,"/"));if(bt.getDate()!=et.getDate()){bt.setTime(et.getTime());bt.setHours(0);bt.setMinutes(0);bt.setSeconds(0);m_strStartTimeSet[0]=bt.Format("yyyy-MM-dd hh:mm:ss")}var last=m_strStartTimeSet.length-1;bt=new Date(m_strStartTimeSet[last].replace(/-/g,"/")),et=new Date(m_strEndTimeSet[last].replace(/-/g,"/"));if(bt.getDate()!=et.getDate()){et.setHours(0);et.setMinutes(0);et.setSeconds(0);m_strEndTimeSet[last]=et.Format("yyyy-MM-dd hh:mm:ss")}}refreshDlList()};var isXvr=m_objectParent.m_devicetype=="XVR"?true:false;$("#videoBlock").isPlayer("getDownloadFileInfo",ch,type,year,month,day,conv,isXvr)}function searchMonthRec(ch,type,date,callback){var year=date.getFullYear(),month=date.getMonth()+1;var funcName=isXVR()?"getPlayBackMonthRecordStatus":"getPlayBackMonthRecordStatusEX";var $cal=$("#div1"),player=$("#videoBlock");$cal.commCal("hlDates",[]);if(g_isBsCal){var firstDate=$cal.commCal("getMonthFirstDay",date);var lastDate=$cal.commCal("getMonthLastDay",date);if(firstDate.getMonth()!==lastDate.getMonth()){var allRec=[];year=lastDate.getFullYear(),month=lastDate.getMonth()+1;player.isPlayer(funcName,ch,type,year,month,getMonDays(year,month),function(jsonFileInfo){allRec=allRec.concat($.map(eval("(["+jsonFileInfo.substr(0,jsonFileInfo.length-1)+"])"),function(node){return new Date(node.RecordStatusDay)}));year=firstDate.getFullYear(),month=firstDate.getMonth()+1;player.isPlayer(funcName,ch,type,year,month,getMonDays(year,month),function(jsonFileInfo){allRec=allRec.concat($.map(eval("(["+jsonFileInfo.substr(0,jsonFileInfo.length-1)+"])"),function(node){return new Date(node.RecordStatusDay)}));allRec.sort(function(a,b){return a.getTime()-b.getTime()});var len=0;for(var i=0;i<allRec.length;++i){if(cmpInDay(firstDate,allRec[i])>0){++len}else{break}}if(len>0){allRec.splice(0,len)}var idx=-1;for(var i=allRec.length-1;i>=0;--i){if(cmpInDay(lastDate,allRec[i])<0){idx=i}else{break}}if(idx>=0){allRec.splice(idx,allRec.length-idx)}saveChMonthRec(ch,type,date,allRec);callback&&callback(allRec)})});return}}player.isPlayer(funcName,ch,type,year,month,getMonDays(year,month),function(jsonFileInfo){var arrRec=$.map(eval("(["+jsonFileInfo.substr(0,jsonFileInfo.length-1)+"])"),function(node){return new Date(node.RecordStatusDay)});arrRec.sort(function(a,b){return a.getTime()-b.getTime()});saveChMonthRec(ch,type,date,arrRec);callback&&callback(arrRec)})}function refreshDlList(){DeleteFile();var c=m_strStartTimeSet.length;var b=0;m_nAllFileNumber=c;b=c;if(b==0){m_nAllPage=ParseInt(b/m_nGoOutNum)+1}if(b%m_nGoOutNum==0&&b!=0){m_nAllPage=ParseInt(b/m_nGoOutNum)}else{m_nAllPage=ParseInt(b/m_nGoOutNum)+1}m_nShowPage=1;if(b>m_nGoOutNum){for(var a=0;a<m_nGoOutNum;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}m_nShowFileNumber=m_nGoOutNum}else{for(var a=0;a<b;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}m_nShowFileNumber=b}document.getElementById("ChangePage").innerHTML=lang.dl7+m_nAllFileNumber+lang.dl8+"&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlFirstPage()'>"+lang.dl9+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlLastPage()'>"+lang.dl10+"</span>&nbsp;"+m_nShowPage+"/"+m_nAllPage+"&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlNextPage()'>"+lang.dl11+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlAfterPage()'>"+lang.dl12+"</span>&nbsp;&nbsp;";$(".searchtime").removeClass("noclick")}function downlNextPage(){if(m_nShowPage==m_nAllPage||m_nDlPos==1){return}DeleteFile();m_nShowPage++;if(m_nShowPage==m_nAllPage){m_nShowFileNumber=m_nAllFileNumber-m_nGoOutNum*(m_nShowPage-1);for(var a=m_nGoOutNum*(m_nShowPage-1);a<m_nAllFileNumber;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}}else{m_nShowFileNumber=m_nGoOutNum;for(var a=m_nGoOutNum*(m_nShowPage-1);a<m_nGoOutNum*m_nShowPage;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}}$("#checkall").prop("checked",false);document.getElementById("ChangePage").innerHTML=lang.dl7+m_nAllFileNumber+lang.dl8+"&nbsp;&nbsp;<span style='cursor:pointer; border-bottom:1px solid #000;' onClick='downlFirstPage()'>"+lang.dl9+"</span>&nbsp;&nbsp;<span style='cursor:pointer; border-bottom:1px solid #000;' onClick='downlLastPage()'>"+lang.dl10+"</span>&nbsp;"+m_nShowPage+"/"+m_nAllPage+"&nbsp;<span style='cursor:pointer; border-bottom:1px solid #000;' onClick='downlNextPage()'>"+lang.dl11+"</span>&nbsp;&nbsp;<span style='cursor:pointer; border-bottom:1px solid #000;' onClick='downlAfterPage()'>"+lang.dl12+"</span>&nbsp;&nbsp;"}function downlLastPage(){if(m_nShowPage==1||m_nDlPos==1){return}DeleteFile();m_nShowPage--;for(var a=m_nGoOutNum*(m_nShowPage-1);a<m_nGoOutNum*m_nShowPage;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}m_nShowFileNumber=m_nGoOutNum;$("#checkall").prop("checked",false);document.getElementById("ChangePage").innerHTML=lang.dl7+m_nAllFileNumber+lang.dl8+"&nbsp;&nbsp;<span style='cursor:pointer; border-bottom:1px solid #000;' onClick='downlFirstPage()'>"+lang.dl9+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlLastPage()'>"+lang.dl10+"</span>&nbsp;"+m_nShowPage+"/"+m_nAllPage+"&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlNextPage()'>"+lang.dl11+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlAfterPage()'>"+lang.dl12+"</span>&nbsp;&nbsp;"}function downlFirstPage(){if(m_nShowPage==1||m_nDlPos==1){return}DeleteFile();m_nShowPage=1;for(var a=0;a<m_nGoOutNum;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}m_nShowFileNumber=m_nGoOutNum;$("#checkall").prop("checked",false);document.getElementById("ChangePage").innerHTML=lang.dl7+m_nAllFileNumber+lang.dl8+"&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlFirstPage()'>"+lang.dl9+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlLastPage()'>"+lang.dl10+"</span>&nbsp;"+m_nShowPage+"/"+m_nAllPage+"&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlNextPage()'>"+lang.dl11+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlAfterPage()'>"+lang.dl12+"</span>&nbsp;&nbsp;"}function downlAfterPage(){if(m_nShowPage==m_nAllPage||m_nDlPos==1){return}DeleteFile();m_nShowPage=m_nAllPage;for(var a=(m_nAllPage-1)*m_nGoOutNum;a<m_nAllFileNumber;a++){InsertFile(a+1,m_strFileNameSet[a],m_strStartTimeSet[a],m_strEndTimeSet[a],m_strFileSizeSet[a])}m_nShowFileNumber=m_nAllFileNumber-(m_nAllPage-1)*m_nGoOutNum;$("#checkall").prop("checked",false);document.getElementById("ChangePage").innerHTML=lang.dl7+m_nAllFileNumber+lang.dl8+"&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlFirstPage()'>"+lang.dl9+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlLastPage()'>"+lang.dl10+"</span>&nbsp;"+m_nShowPage+"/"+m_nAllPage+"&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlNextPage()'>"+lang.dl11+"</span>&nbsp;&nbsp;<span style='cursor:pointer;border-bottom:1px solid #000;' onClick='downlAfterPage()'>"+lang.dl12+"</span>&nbsp;&nbsp;"}function InsertFile(r,q,o,n,m){var k=parseFloat(m/1048576).toFixed(3);var l;var i;l=document.getElementById("FileTable").insertRow(document.getElementById("FileTable").rows.length);l.style.height=16;l.style.color="#000000";l.style.cursor="pointer";l.align="center";l.id="fileTr"+r;$(l).bind("click",{iIndex:r},function(b){var a=ParseInt(b.data.iIndex);SelectFile(a)}).addClass((r%2==0)?"odd":"");for(j=0;j<document.getElementById("FileTable").rows[0].cells.length;j++){i=l.insertCell(j);i.align="center";switch(j){case 0:i.innerHTML="<div><input name='box"+r+"' id='box"+r+"' type='checkbox' value='0' onClick='DownLoadCheckAll()'></div>";i.width="40";break;case 1:i.innerHTML=r;i.width="40";break;case 2:var g=q.split("_");var h=[];var p=parseInt($("#SearchChannelSlt").val())+1;h.push("record");h.push(("0000"+p).substr(-4));h.push(("0000"+g[1]).substr(-4));h.push(o.replace(/[^\d]/g,""));h.push(n.replace(/[^\d]/g,""));i.innerHTML=h.join("_")+gRecSubffix;i.width="160";break;case 3:i.innerHTML=o;i.width="140";break;case 4:i.innerHTML=n;i.width="140";break;case 5:if(k==0){i.innerHTML="1 MB";i.width="90";break}else{i.innerHTML=k+" MB";i.width="90";break}case 6:i.innerHTML="<span id='eidtTime"+r+"'>"+lang.eidt+"</span>                                <div id='timeChoose"+r+"' class='hide'>                                    <input id='customStartTime"+r+"' type='text' class='txt' readonly='readonly'> -                                     <input id='customEndTime"+r+"' type='text' class='txt' readonly='readonly'>                                     <span id='close"+r+"'>×</span>                                </div>";i.width="140";break;case 7:i.id="DownLoadProcess"+r;break;default:break}}$("#eidtTime"+r).bind("click",function(){if(m_bDownload){return}$(this).hide();$("#timeChoose"+r).show();$("#customEndTime"+r).click()});$("#customStartTime"+r).data("date",$("#fileTr"+r).children()[3].innerHTML);$("#customEndTime"+r).data("date",$("#fileTr"+r).children()[4].innerHTML);$("#close"+r).bind("click",function(){if(m_bDownload){rightPopup(lang.downloading);return}$("#customStartTime"+r).val("");$("#customEndTime"+r).val("");$("#timeChoose"+r).hide();$("#eidtTime"+r).show()});$("#customStartTime"+r).click(showTimeDlg);$("#customEndTime"+r).click(showTimeDlg);m_strTableFileName[r-1]=q}function showTimeDlg(){if(m_bDownload){return}var g=$(this);SelectFile(g.parents("tr").eq(0).index());var k,f;if(g.index()===0){k=g;f=k.next()}else{f=g;k=f.prev()}var h=$("#dlgTime");k.val()||k.val(k.data("date").split(" ")[1]);f.val()||f.val(f.data("date").split(" ")[1]);h.removeClass("hide").attr("title",lang.handCheck).dialog({draggable:false,resizable:false,width:500,modal:true,position:{my:"right top",at:"right bottom",of:g},buttons:[{text:lang.confirm,"class":"confirmBtn",click:function(){var i=$("tr.select input.txt").eq(0),n=$("tr.select input.txt").eq(1);var e=$("#sliderTime").slider("values");if(e[0]>=e[1]){return alert(lang.setTimeTips2)}var m=new Date(e[0]*1000),o=new Date(e[1]*1000);i.data("date",getDateStr(m));n.data("date",getDateStr(o));i.val(getTimeStr(m));n.val(getTimeStr(o));$(this).dialog("close")}},{text:lang.cancel,click:function(){$(this).dialog("close")}}],close:onDlgTimeCls});try{$("#sliderTime").slider("destroy")}catch(d){}var l=ParseInt(k.attr("id").substr("customStartTime".length))-1;$("#sliderTime").slider({min:date2sec(m_strStartTimeSet[l]),max:date2sec(m_strEndTimeSet[l]),range:true,slide:slider2ipt,change:slider2ipt,values:[date2sec(k.data("date")),date2sec(f.data("date"))]});var b=k.val().split(":").concat(f.val().split(":"));var c=$("#dlgTime input");for(var a=0;a<c.length;++a){c.eq(a).val(b[a])}}function getTimeStr(a){return("0"+a.getHours()).substr(-2)+":"+("0"+a.getMinutes()).substr(-2)+":"+("0"+a.getSeconds()).substr(-2)}function onDlgTimeCls(){var b=$("tr.select input.txt").eq(0),c=$("tr.select input.txt").eq(1);var a=ParseInt(b.attr("id").substr("customStartTime".length))-1;if(m_strStartTimeSet[a]===b.data("date")&&m_strEndTimeSet[a]===c.data("date")){$("tr.select [id^='timeChoose']>span").click()}}function slider2ipt(g,f){if(!g.cancelable){return}var b=new Date(f.value*1000);var d=("0"+b.getHours()).substr(-2);var a=("0"+b.getMinutes()).substr(-2);var c=("0"+b.getSeconds()).substr(-2);if($(f.handle).index()===1){$("#iptBh").val(d);$("#iptBm").val(a);$("#iptBs").val(c)}else{$("#iptEh").val(d);$("#iptEm").val(a);$("#iptEs").val(c)}}function getEdtBt(a){return date2sec(m_strStartTimeSet[a].split(" ")[0]+" "+$("#iptBh").val()+":"+$("#iptBm").val()+":"+$("#iptBs").val())}function getEdtEt(a){return date2sec(m_strEndTimeSet[a].split(" ")[0]+" "+$("#iptEh").val()+":"+$("#iptEm").val()+":"+$("#iptEs").val())}function onTimeEdtChg(o,c,k){var p=$("tr.select input.txt").eq(0),n=$("tr.select input.txt").eq(1);var t=ParseInt(p.attr("id").substr("customStartTime".length))-1;var l=o.parent().index()===0,f=getEdtBt(t),e=getEdtEt(t);var g=l?date2sec(m_strStartTimeSet[t]):f,r=l?e:date2sec(m_strEndTimeSet[t]),a=l?f:e;var q=a;a=Math.max(Math.min(r,a),g);if(a!==q){var b=new Date(a*1000);var i=("0"+b.getHours()).substr(-2);var d=("0"+b.getMinutes()).substr(-2);var u=("0"+b.getSeconds()).substr(-2);if(l){$("#iptBh").val(i);$("#iptBm").val(d);$("#iptBs").val(u)}else{$("#iptEh").val(i);$("#iptEm").val(d);$("#iptEs").val(u)}}$("#sliderTime").slider("values",l?0:1,a)}function DownLoadCheckAll(){var b=0;for(var a=(m_nShowPage-1)*m_nGoOutNum;a<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);a++){if($("#box"+(a+1)).prop("checked")){b++}}if(b==m_nShowFileNumber){$("#checkall").prop("checked",true)}else{$("#checkall").prop("checked",false)}}function SelectFile(b){var a=0;if(m_nDlPos==1){return}$("table.dlsubtable tr.select").removeClass("select");$("#fileTr"+b).addClass("select")}function DeleteFile(){if(m_nShowFileNumber==0){return}for(var a=0;a<m_nShowFileNumber;a++){m_strTableFileName[a]="";document.getElementById("FileTable").deleteRow(1)}}function DownLoadFile(){var h=lang.dl14;var g=lang.dl15;var n=0;var a=0;$("[id^=DownLoadProcess]").html("");if(isIE()){if(m_nDownloadFileIndex!=-1){if(confirm(h)){m_bDownload=false;if(0==$("#videoBlock").isPlayer("downloadRecordFileStop",$("#SearchChannelSlt").val(),String(m_nDownloadFileIndex))){m_nDownloadFileIndex=-1;m_nDlPos=0;m_bDownload=false;for(var c=(m_nShowPage-1)*m_nGoOutNum;c<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);c++){$("#box"+(c+1)).prop("disabled",false);$("#box"+(c+1)).prop("checked",false)}$("#checkall").prop("disabled",false);clearInterval(m_nDlTime);$("#DownloadBtn").val(lang.dl4)}}return}for(var f=(m_nShowPage-1)*m_nGoOutNum;f<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);f++){if($("#box"+(f+1)).prop("checked")){var l=m_fileIndex[f];m_nDownloadFileIndex=$("#videoBlock").isPlayer("downloadRecordFileStart",$("#SearchChannelSlt").val(),l);if(m_nDownloadFileIndex==0){m_nDownloadFileIndex=-1;rightPopup(lang.rootErr);return}var m=$("#customStartTime"+(f+1)).val();var o=$("#customEndTime"+(f+1)).val();m_nNowDown=f;if(m==""&&o==""&&(f==0||f==m_strStartTimeSet.length-1)){m=o="1"}if(m==""&&o==""){m_nDownloadFileIndex=$("#videoBlock").isPlayer("downloadRecordFileStart",$("#SearchChannelSlt").val(),l)}else{var b=$("#customStartTime"+(f+1)).data("date");var e=$("#customEndTime"+(f+1)).data("date");m_nDownloadFileIndex=$("#videoBlock").isPlayer("downloadRecordFileStart",$("#SearchChannelSlt").val(),m_fileIndex[f],new Date(b.replace(/-/g,"/")).getTime()/1000,new Date(e.replace(/-/g,"/")).getTime()/1000)}m_bDownload=true;if(m_nDownloadFileIndex!=-1){m_nDlPos=1}if(m_nDlTime){clearInterval(m_nDlTime);m_nDlTime=0}m_nDlTime=setInterval("DownLoadProcess()",1000);n++;$("#DownloadBtn").val(lang.stop);break}}if(m_nDownloadFileIndex==0){return}if(n==0){return alert(g)}if(n==a){return}for(var d=(m_nShowPage-1)*m_nGoOutNum;d<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);d++){$("#box"+(d+1)).prop("disabled",true)}$("#checkall").prop("disabled",true);rightPopup(lang.downTip)}else{currentFileList=[],currentFileIndex=0;for(var f=(m_nShowPage-1)*m_nGoOutNum;f<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);f++){if($("#box"+(f+1)).prop("checked")){var m=$("#customStartTime"+(f+1));var o=$("#customEndTime"+(f+1));if(m.val()&&o.val()){m_strStartTimeSet[f]=m.data("date");m_strEndTimeSet[f]=o.data("date")}currentFileList.push(m_fileIndex[f])}}!$("#DownloadBtn").hasClass("start")?startDownFile(currentFileIndex):stopDownFile()}}function SelectAllFile(){if($("#checkall").prop("checked")){for(var a=(m_nShowPage-1)*m_nGoOutNum;a<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);a++){$("#box"+(a+1)).prop("checked",true)}}else{for(var a=(m_nShowPage-1)*m_nGoOutNum;a<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);a++){$("#box"+(a+1)).prop("checked",false)}}}function DownLoadProcess(){if(m_nDownloadFileIndex<0){return}var e=$("#videoBlock").isPlayer("getDownloadStatus",$("#SearchChannelSlt").val(),m_nDownloadFileIndex);if(e==0){var k=$("#videoBlock").isPlayer("getDownloadProgress",$("#SearchChannelSlt").val(),m_nDownloadFileIndex);if(k<0){clearInterval(m_nDlTime);m_nDlTime=0;return}else{if(k<100){$("#DownLoadProcess"+(m_nNowDown+1)).html(k+"%")}else{$("#DownLoadProcess"+(m_nNowDown+1)).html(lang.dl6);$("#videoBlock").isPlayer("downloadRecordFileStop",$("#SearchChannelSlt").val(),m_nDownloadFileIndex);m_nDownloadFileIndex=-1;m_nDlPos=0;clearInterval(m_nDlTime);m_bDownload=false;m_nDlTime=0;$("#DownloadBtn").val(lang.dl4);for(var c=m_nNowDown+1;c<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);++c){if($("#box"+(c+1)).prop("checked")){var f=m_fileIndex[c];m_nNowDown=c;var g=$("#customStartTime"+(c+1)).val();var h=$("#customEndTime"+(c+1)).val();if(g==""&&h==""&&(c==0||c==m_strStartTimeSet.length-1)){g=h="1"}if(g==""&&h==""){m_nDownloadFileIndex=$("#videoBlock").isPlayer("downloadRecordFileStart",$("#SearchChannelSlt").val(),f,(new Date(m_strStartTimeSet[f])-timeZooe)/1000,(new Date(m_strEndTimeSet[f])-timeZooe)/1000,m_strFileTypeSet[f],m_strFileSizeSet[f],m_strFileNameSet[f])}else{var a=$("#customStartTime"+(c+1)).data("date");var d=$("#customEndTime"+(c+1)).data("date");m_nDownloadFileIndex=$("#videoBlock").isPlayer("downloadRecordFileStart",$("#SearchChannelSlt").val(),f,new Date(a.replace(/-/g,"/")).getTime()/1000,new Date(d.replace(/-/g,"/")).getTime()/1000,m_strFileTypeSet[f],m_strFileSizeSet[f],m_strFileNameSet[f])}if(m_nDlTime){clearInterval(m_nDlTime);m_nDlTime=0}m_bDownload=true;m_nDlTime=setInterval("DownLoadProcess()",1000);$("#DownloadBtn").val(lang.stop);return}}for(var b=(m_nShowPage-1)*m_nGoOutNum;b<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);b++){$("#box"+(b+1)).prop("disabled",false);$("#box"+(b+1)).prop("checked",false)}$("#checkall").prop("disabled",false).prop("checked",false);$("#DownloadBtn").val(lang.dl4)}}}else{clearInterval(m_nDlTime);$("#videoBlock").isPlayer("downloadRecordFileStop",$("#SearchChannelSlt").val(),m_nDownloadFileIndex);m_bDownload=false;m_nDownloadFileIndex=-1;m_nDlPos=0;$("#DownLoadProcess"+(m_nNowDown+1)).html(lang.dl5);for(var b=(m_nShowPage-1)*m_nGoOutNum;b<((m_nShowPage-1)*m_nGoOutNum+m_nShowFileNumber);b++){$("#box"+(b+1)).prop("disabled",false).prop("checked",false)}$("#checkall").prop("disabled",false).prop("checked",false);$("#DownloadBtn").val(lang.dl4);return}}function stopDownFile(){$("#videoBlock").isPlayer("downloadRecordFileStop");$("#DownloadBtn").val(lang.dl4).removeClass("start")}function startDownFile(b){!b&&(b=0);if(!currentFileList.length){return}var b=currentFileList[b];var e=parseInt($("#SearchChannelSlt").val());var g=m_strFileNameSet[b].split("_");var f=[];var c=e+1;var a=m_strStartTimeSet[b];var d=m_strEndTimeSet[b];f.push("record");f.push(("0000"+c).substr(-4));f.push(("0000"+g[1]).substr(-4));f.push(a.replace(/[^\d]/g,""));f.push(d.replace(/[^\d]/g,""));fileName=f.join("_")+gRecSubffix;$("#videoBlock").isPlayer("downloadRecordFileStart",e,b,(new Date(a)-timeZooe)/1000,(new Date(d)-timeZooe)/1000,m_strFileTypeSet[b],m_strFileSizeSet[b],m_strFileNameSet[b]);$("#DownloadBtn").val(lang.stop).addClass("start")}function getUpdateProcess(b){var a=currentFileList[currentFileIndex]+1;$("#DownLoadProcess"+a).html(b+"%");if(b==100){stopDownFile();currentFileIndex++;if(currentFileList[currentFileIndex]){startDownFile(currentFileIndex)}else{$("#DownloadBtn").val(lang.dl4).removeClass("start")}}}function getFileIndex(b){for(var a=0;a<m_strStartTimeSet.length;a++){if(m_strStartTimeSet[a]==b){return currentFileIndex=parseInt(a)+1}}}function setSdk(){}function getLocalServerWebsocketStatus(){if(isIE()){return false}return localServerWebsocket.websocket.readyState==3||localServerWebsocket.websocket.readyState==2}function onDownload(a){a==-1&&rightPopup(lang.rootErr)}function getMonthBeginEnd(b,d){var a={begin:0,end:0};var c=new Date();c.setFullYear(b);c.setMonth(d);c.setDate(1);c.setHours(0);c.setMinutes(0);c.setSeconds(0);c.setMilliseconds(0);a.begin=c.getTime();c.setMonth(d+1);c.setSeconds(-1);a.end=c.getTime();return a}function getArrRec(f){var a=new Date();var c=a.getFullYear(),d=a.getMonth()+1;(d<10)&&(d="0"+d);var e=[];for(var b=0;b<f.length;b++){(f[b]<10)&&(f[b]="0"+f[b]);e.push(new Date(String(c+"-"+d+"-"+f[b])))}return e}function onImplement(){};